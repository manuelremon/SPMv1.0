<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SPM ¬∑ Dashboard</title>
  <link rel="icon" href="/assets/spm-logo.png" type="image/png">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      /* DARK MODE PREMIUM - Violeta Premium + Oscuro Elegante */
      --primary: #7c3aed;
      --primary-light: #a78bfa;
      --primary-dark: #5b21b6;
      --success: #10b981;
      --success-light: #34d399;
      --warning: #f59e0b;
      --danger: #ef4444;
      --danger-light: #f87171;
      
      /* Backgrounds - Deep & Professional */
      --bg-primary: #1a1f35;
      --bg-secondary: #262d48;
      --bg-tertiary: #37415d;
      --bg-canvas: #0f1729;
      --bg-canvas-inset: #0a0e1a;
      
      /* Legacy aliases - for compatibility */
      --bg-card: var(--bg-primary);
      --bg-darker: var(--bg-secondary);
      --border: var(--border-default);
      --border-light: #37415d;
      
      /* Text colors - Premium contrast for dark mode */
      --text-primary: #f3f4f6;
      --text-secondary: #d1d5db;
      --text-tertiary: #9ca3af;
      
      /* Borders - Subtle elegance for dark mode */
      --border-default: #3f4655;
      --border-muted: #2d3342;
      
      /* Accents for cards and highlights */
      --accent-blue: #1e3a8a;
      --accent-purple: #4c1d95;
      --accent-emerald: #064e3b;
      
      /* Transitions */
      --transition: all 0.2s ease-in-out;
    }

    html, body {
      width: 100%;
      height: 100%;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
      background: var(--bg-secondary);
      color: var(--text-primary);
      overflow: hidden;
    }

    body {
      display: flex;
      height: 100vh;
    }

    /* ========== SIDEBAR ========== */
    .sidebar {
      width: 260px;
      background: var(--bg-primary);
      border-right: 1px solid var(--border-default);
      display: flex;
      flex-direction: column;
      padding: 16px 0;
      overflow-y: auto;
      overflow-x: hidden;
      box-shadow: none;
    }

    .sidebar-header {
      padding: 0 16px 12px;
      display: flex;
      align-items: center;
      gap: 12px;
      border-bottom: 1px solid var(--border-default);
      margin-bottom: 12px;
    }

    .sidebar-logo {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      background: transparent;
      overflow: hidden;
      flex-shrink: 0;
    }

    .sidebar-logo img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .sidebar-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .sidebar-nav {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 2px;
      padding: 0 8px;
    }

    .nav-section {
      margin-bottom: 16px;
    }

    .nav-section-title {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      color: var(--text-tertiary);
      padding: 8px 12px;
      margin-bottom: 8px;
      letter-spacing: 0.5px;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 12px;
      border-radius: 6px;
      color: var(--text-secondary);
      text-decoration: none;
      transition: var(--transition);
      cursor: pointer;
      border: none;
      background: transparent;
      width: 100%;
      font-size: 13px;
      font-weight: 500;
      font-family: inherit;
    }

    .nav-item:hover {
      background: var(--bg-secondary);
      color: var(--text-primary);
    }

    .nav-item.active {
      background: var(--bg-secondary);
      color: var(--primary);
      border-left: none;
      padding-left: 13px;
    }

    .nav-icon {
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }

    .sidebar-footer {
      padding: 24px 12px 0;
      border-top: 1px solid var(--border);
      margin-top: auto;
    }

    .user-profile {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      background: var(--bg-secondary);
      border-radius: 6px;
      margin-bottom: 12px;
    }

    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 16px;
    }

    .user-info {
      flex: 1;
      min-width: 0;
    }

    .user-name {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .user-role {
      font-size: 12px;
      color: var(--text-secondary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* ========== MAIN CONTENT ========== */
    .main-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* ========== HEADER ========== */
    .header {
      padding: 16px 32px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid var(--border-default);
      background: var(--bg-primary);
      box-shadow: none;
    }

    .header-content {
      display: flex;
      align-items: center;
      gap: 20px;
      flex: 1;
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .action-btn {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      background: rgba(124, 58, 237, 0.08);
      border: 1px solid var(--border);
      color: var(--text-secondary);
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      position: relative;
    }

    .action-btn:hover {
      background: rgba(124, 58, 237, 0.15);
      color: var(--primary);
      border-color: var(--primary);
    }

    /* Floating notification button */
    .action-btn.floating {
      position: fixed;
      bottom: 30px;
      right: 30px;
      z-index: 1000;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: var(--primary);
      border: none;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      animation: floatingPulse 3s ease-in-out infinite;
    }

    .action-btn.floating:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
    }

    .notification-icon {
      font-size: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .notification-badge {
      position: absolute;
      top: -8px;
      right: -8px;
      background: var(--danger);
      color: white;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: 600;
      border: 2px solid white;
      animation: badgePulse 2s ease-in-out infinite;
    }

    @keyframes floatingPulse {
      0%, 100% {
        transform: translateY(0) scale(1);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }
      50% {
        transform: translateY(-4px) scale(1.02);
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
      }
    }

    @keyframes badgePulse {
      0%, 100% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.08);
      }
    }

    /* ========== CONTENT AREA ========== */
    .content {
      flex: 1;
      overflow-y: auto;
      padding: 32px;
    }

    .content-header {
      margin-bottom: 32px;
    }
    
    #page-new-request .content-header {
      background: var(--bg-primary);
      backdrop-filter: none;
      padding: 24px 32px;
      margin: 0;
      border-bottom: 1px solid var(--border-default);
      border-image: none;
      box-shadow: none;
      animation: none;
      overflow: visible;
    }
    
    /* Animated background gradient */
    #page-new-request .content-header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 0;
      height: 0;
      background: transparent;
    }
    
    @keyframes slideDownBoom {
      0% {
        opacity: 1;
        transform: none;
        filter: none;
      }
      100% {
        opacity: 1;
        transform: none;
        filter: none;
      }
    }
    
    @keyframes fieldFill {
      0% {
        background: var(--bg-primary);
      }
      100% {
        background: var(--bg-secondary);
      }
    }

    @keyframes fieldGlimmer {
      0% { opacity: 0.5; }
      50% { opacity: 0.7; }
      100% { opacity: 0.5; }
    }
    
    #page-new-request .content-header .page-title {
      transition: var(--transition);
      letter-spacing: 0;
      background: none;
      -webkit-background-clip: unset;
      -webkit-text-fill-color: unset;
      background-clip: unset;
      position: relative;
      z-index: 2;
      font-size: 24px;
      color: var(--text-primary);
      font-weight: 600;
    }
    
    #page-new-request .content-header .page-subtitle {
      transition: var(--transition);
      opacity: 1;
      color: var(--text-secondary);
      position: relative;
      z-index: 2;
      font-size: 13px;
    }

    .page-title {
      font-size: 28px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .page-subtitle {
      font-size: 13px;
      color: var(--text-secondary);
    }

    /* ========== DASHBOARD GRID ========== */
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 16px;
      margin-bottom: 32px;
    }

    .stat-card {
      background: var(--bg-primary);
      border: 1px solid var(--border-default);
      border-radius: 8px;
      padding: 20px;
      transition: var(--transition);
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      width: 100%;
      height: 100%;
      background: transparent;
      transition: var(--transition);
    }

    .stat-card:hover {
      background: var(--bg-secondary);
      border-color: var(--primary);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .stat-card-content {
      position: relative;
      z-index: 1;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }

    .stat-info {
      flex: 1;
    }

    .stat-label {
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      color: var(--text-secondary);
      margin-bottom: 8px;
      letter-spacing: 0.5px;
    }

    .stat-value {
      font-size: 32px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 8px;
    }

    .stat-change {
      font-size: 12px;
      color: var(--success);
      font-weight: 600;
    }

    .stat-icon {
      width: 48px;
      height: 48px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      background: var(--bg-secondary);
      color: var(--primary);
    }

    /* ========== ACTIVITY SECTION ========== */
    .activity-section {
      background: var(--bg-primary);
      border: 1px solid var(--border-default);
      border-radius: 8px;
      padding: 24px;
      margin-bottom: 32px;
    }

    .section-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 24px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .activity-list {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .activity-item {
      display: flex;
      gap: 16px;
      padding: 16px;
      background: rgba(124, 58, 237, 0.05);
      border-radius: 8px;
      border-left: 3px solid var(--primary);
      transition: var(--transition);
    }

    .activity-item:hover {
      background: rgba(124, 58, 237, 0.08);
      border-left-color: var(--accent);
      transform: translateX(4px);
    }

    .activity-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: rgba(124, 58, 237, 0.15);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      font-size: 18px;
    }

    .activity-content {
      flex: 1;
    }

    .activity-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .activity-time {
      font-size: 12px;
      color: var(--text-secondary);
    }

    /* ========== CHARTS SECTION ========== */
    .charts-section {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 24px;
      margin-bottom: 40px;
    }

    .chart-container {
      background: linear-gradient(135deg, rgba(30, 41, 59, 0.5) 0%, rgba(15, 23, 42, 0.5) 100%);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 24px;
    }

    .chart-title {
      font-size: 16px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 15px;
    }

    .chart-spacer {
      margin-top: 20px;
    }

    .activity-loading {
      text-align: center;
      color: var(--text-secondary);
      padding: 20px;
    }

    /* ========== PAGE NAVIGATION ========== */
    .page-content {
      display: none;
      animation: fadeIn 0.3s ease-in;
    }

    .page-content.active {
      display: block;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Empty state styling */
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 60px 20px;
      background: linear-gradient(135deg, rgba(124, 58, 237, 0.05) 0%, rgba(236, 72, 153, 0.05) 100%);
      border: 1px solid var(--border);
      border-radius: 12px;
      text-align: center;
      min-height: 400px;
    }

    .empty-state-icon {
      font-size: 64px;
      margin-bottom: 16px;
      opacity: 0.8;
    }

    .empty-state h3 {
      font-size: 24px;
      margin: 0 0 8px 0;
      color: var(--text-primary);
    }

    .empty-state p {
      margin: 0 0 24px 0;
      color: var(--text-secondary);
      font-size: 14px;
      max-width: 400px;
    }

    .btn-empty {
      padding: 12px 24px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      box-shadow: 0 4px 15px rgba(124, 58, 237, 0.25);
    }

    .btn-empty:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(124, 58, 237, 0.35);
    }

    .btn-empty:active {
      transform: translateY(0);
    }

    .hidden {
      display: none !important;
    }

    /* ========== SCROLLBAR ========== */
    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: rgba(124, 58, 237, 0.25);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: rgba(124, 58, 237, 0.45);
    }

    /* ========== RESPONSIVE ========== */
    @media (max-width: 1200px) {
      .sidebar {
        width: 240px;
      }

      .content {
        padding: 32px;
      }

      .header {
        padding: 16px 32px;
      }
    }

    @media (max-width: 768px) {
      body {
        flex-direction: column;
      }

      .sidebar {
        width: 100%;
        padding: 16px 0;
        flex-direction: row;
        max-height: 80px;
        overflow-x: auto;
        overflow-y: hidden;
      }

      .sidebar-header {
        padding: 0 16px;
        margin-bottom: 0;
        border-bottom: none;
        border-right: 1px solid var(--border);
      }

      .sidebar-nav {
        flex-direction: row;
        flex: 1;
        padding: 0 16px;
      }

      .nav-section {
        display: flex;
        gap: 8px;
        margin-bottom: 0;
      }

      .nav-section-title {
        display: none;
      }

      .sidebar-footer {
        display: none;
      }

      .content {
        padding: 24px;
      }

      .header {
        padding: 16px 24px;
        gap: 16px;
      }

      .search-box {
        display: none;
      }

      .dashboard-grid {
        grid-template-columns: 1fr;
      }
    }

    /* ===== AI ASSISTANT WIDGET ===== */
    .ai-widget-container {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 9999;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .ai-widget-button {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      border: none;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      box-shadow: 0 4px 16px rgba(124, 58, 237, 0.3);
      transition: all 0.3s ease;
      animation: pulse 2s infinite;
    }

    .ai-widget-button:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 24px rgba(124, 58, 237, 0.5);
      animation: none;
    }

    @keyframes pulse {
      0%, 100% {
        box-shadow: 0 4px 16px rgba(124, 58, 237, 0.3);
      }
      50% {
        box-shadow: 0 4px 24px rgba(124, 58, 237, 0.6);
      }
    }

    .ai-panel {
      position: absolute;
      bottom: 80px;
      right: 0;
      width: 380px;
      max-height: 600px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-default);
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
      display: none;
      flex-direction: column;
      overflow: hidden;
      animation: slideUp 0.3s ease;
    }

    .ai-panel.active {
      display: flex;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .ai-panel-header {
      padding: 16px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      border-bottom: 1px solid var(--border-muted);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .ai-panel-title {
      font-size: 16px;
      font-weight: 600;
      margin: 0;
    }

    .ai-panel-close {
      background: none;
      border: none;
      color: white;
      font-size: 20px;
      cursor: pointer;
      padding: 0;
      opacity: 0.8;
      transition: opacity 0.2s;
    }

    .ai-panel-close:hover {
      opacity: 1;
    }

    .ai-panel-content {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }

    .ai-message {
      margin-bottom: 12px;
      padding: 12px;
      border-radius: 8px;
      font-size: 13px;
      line-height: 1.4;
    }

    .ai-message.assistant {
      background: var(--bg-tertiary);
      border-left: 3px solid var(--primary);
      color: var(--text-primary);
    }

    .ai-message.user {
      background: var(--primary);
      color: white;
      text-align: right;
    }

    .ai-message.loading {
      background: var(--bg-tertiary);
      border-left: 3px solid var(--warning);
      color: var(--text-secondary);
      font-style: italic;
    }

    .ai-input-area {
      padding: 12px;
      border-top: 1px solid var(--border-default);
      display: flex;
      gap: 8px;
    }

    .ai-input-field {
      flex: 1;
      padding: 10px 12px;
      border: 1px solid var(--border-default);
      border-radius: 6px;
      background: var(--bg-secondary);
      color: var(--text-primary);
      font-size: 13px;
      transition: all 0.2s;
    }

    .ai-input-field:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1);
    }

    .ai-send-button {
      padding: 10px 16px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.2s;
    }

    .ai-send-button:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
    }

    .ai-send-button:active {
      transform: translateY(0);
    }

    .ai-suggestions {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 12px;
    }

    .ai-suggestion-chip {
      padding: 8px 12px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-muted);
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s;
      text-align: left;
    }

    .ai-suggestion-chip:hover {
      background: var(--bg-canvas);
      border-color: var(--primary);
      color: var(--primary);
    }

    .ai-loading-dots {
      display: inline-flex;
      gap: 4px;
    }

    .ai-loading-dots span {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--primary);
      animation: bounce 1.4s infinite;
    }

    .ai-loading-dots span:nth-child(2) {
      animation-delay: 0.2s;
    }

    .ai-loading-dots span:nth-child(3) {
      animation-delay: 0.4s;
    }

    @keyframes bounce {
      0%, 80%, 100% {
        opacity: 0.8;
        transform: translateY(0);
      }
      40% {
        opacity: 1;
        transform: translateY(-6px);
      }
    }

    @media (max-width: 768px) {
      .ai-panel {
        width: 320px;
        max-height: 500px;
      }

      .ai-widget-container {
        bottom: 16px;
        right: 16px;
      }
    }
  </style>
</head>
<body>
  <!-- AI ASSISTANT WIDGET -->
  <div class="ai-widget-container">
    <button class="ai-widget-button" onclick="toggleAIPanel()" title="Asistente IA">
      ü§ñ
    </button>
    <div class="ai-panel" id="aiPanel">
      <div class="ai-panel-header">
        <h3 class="ai-panel-title">Asistente IA</h3>
        <div style="display: flex; gap: 6px;">
          <button class="ai-panel-btn" onclick="clearAIHistory()" title="Limpiar historial" style="padding: 6px 8px; font-size: 12px; cursor: pointer; background: #f5f5f5; border: 1px solid #ddd; border-radius: 4px;">üóëÔ∏è</button>
          <button class="ai-panel-close" onclick="toggleAIPanel()">‚úï</button>
        </div>
      </div>
      <div class="ai-panel-content" id="aiPanelContent">
        <div style="text-align: center; padding: 16px; color: var(--text-secondary);">
          <p style="margin-bottom: 12px;">üëã Hola, soy tu asistente de materiales</p>
          <p style="font-size: 12px; margin-bottom: 12px;">Puedo ayudarte con:</p>
          <div class="ai-suggestions" id="aiInitialSuggestions">
            <div class="ai-suggestion-chip" onclick="askAI('¬øCu√°l es el consumo promedio de este material?')">
              üìä Consumo hist√≥rico
            </div>
            <div class="ai-suggestion-chip" onclick="askAI('¬øCu√°l es el stock actual?')">
              üì¶ Estado de stock
            </div>
            <div class="ai-suggestion-chip" onclick="askAI('¬øHay solicitudes pendientes?')">
              ‚è≥ Solicitudes en curso
            </div>
            <div class="ai-suggestion-chip" onclick="askAI('¬øQu√© estado tiene el MRP?')">
              üéØ Estado MRP
            </div>
          </div>
        </div>
      </div>
      <div class="ai-input-area">
        <input type="text" class="ai-input-field" id="aiInput" placeholder="Pregunta sobre materiales (desactivado)..." disabled />
        <button class="ai-send-button" onclick="alert('AI Assistant desactivado')" disabled>üì§</button>
      </div>
    </div>
  </div>

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-logo">
        <img src="/assets/spm-logo.png" alt="SPM Logo">
      </div>
      <div class="sidebar-title">SPM</div>
    </div>

    <nav class="sidebar-nav">
      <!-- MAIN SECTION -->
      <div class="nav-section">
        <a href="#" class="nav-item active" data-page="dashboard">
          <span class="nav-icon">üìä</span>
          <span>Dashboard</span>
        </a>
        <a href="#" class="nav-item" data-page="requests">
          <span class="nav-icon">üìã</span>
          <span>Mis Solicitudes</span>
        </a>
        <a href="#" class="nav-item" data-page="new-request">
          <span class="nav-icon">‚ûï</span>
          <span>Nueva Solicitud</span>
        </a>
        <a href="#" class="nav-item" data-page="add-materials">
          <span class="nav-icon">üì¶</span>
          <span>Agregar Materiales</span>
        </a>
        <a href="#" class="nav-item" data-page="notifications">
          <span class="nav-icon">üîî</span>
          <span>Notificaciones</span>
        </a>
      </div>

      <!-- ADMIN SECTION -->
      <div class="nav-section hidden" id="adminSection">
        <div class="nav-section-title">Administraci√≥n</div>
        <a href="#" class="nav-item" data-page="users">
          <span class="nav-icon">üë•</span>
          <span>Usuarios</span>
        </a>
        <a href="#" class="nav-item" data-page="materials">
          <span class="nav-icon">üì¶</span>
          <span>Materiales</span>
        </a>
        <a href="#" class="nav-item" data-page="centers">
          <span class="nav-icon">üè¢</span>
          <span>Centros</span>
        </a>
        <a href="#" class="nav-item" data-page="warehouses">
          <span class="nav-icon">üè≠</span>
          <span>Almacenes</span>
        </a>
        <a href="#" class="nav-item" data-page="reports">
          <span class="nav-icon">üìä</span>
          <span>Reportes</span>
        </a>
      </div>

      <!-- PLANNER SECTION -->
      <div class="nav-section hidden" id="plannerSection">
        <div class="nav-section-title">Planificaci√≥n</div>
        <a href="#" class="nav-item" data-page="planner" target="_self">
          <span class="nav-icon">üìà</span>
          <span>Planificaci√≥n</span>
        </a>
      </div>

      <!-- SETTINGS SECTION -->
      <div class="nav-section">
        <a href="#" class="nav-item" data-page="preferences">
          <span class="nav-icon">‚öôÔ∏è</span>
          <span>Preferencias</span>
        </a>
        <a href="#" class="nav-item" data-page="help">
          <span class="nav-icon">‚ÑπÔ∏è</span>
          <span>Ayuda</span>
        </a>
      </div>
    </nav>

    <!-- SIDEBAR FOOTER -->
    <div class="sidebar-footer">
      <a href="mi-cuenta.html" class="user-profile">
        <div class="user-avatar" id="userAvatarSmall">M</div>
        <div class="user-info">
          <div class="user-name" id="userNameSidebar">Manuel</div>
          <div class="user-role" id="userRoleSidebar">Admin</div>
        </div>
      </a>
      <button class="nav-item" id="logoutBtn">
        <span class="nav-icon">üö™</span>
        <span>Cerrar Sesi√≥n</span>
      </button>
    </div>
  </aside>

  <!-- MAIN CONTAINER -->
  <div class="main-container">
    <!-- HEADER -->
    <header class="header">
      <div class="header-actions">
        <button class="action-btn notification-btn floating" title="Notificaciones">
          <span class="notification-icon">üîî</span>
          <span class="notification-badge" id="notificationBadge" style="display: none;">0</span>
        </button>
      </div>
    </header>

    <!-- CONTENT -->
    <div class="content">
      <!-- PAGE: DASHBOARD -->
      <div id="page-dashboard" class="page-content active">
        <div class="content-header">
          <h1 class="page-title">Bienvenido, <span id="userName">Manuel</span> üëã</h1>
          <p class="page-subtitle">Aqu√≠ est√° tu resumen de actividad y solicitudes recientes</p>
        </div>

        <!-- STATS DASHBOARD -->
        <div class="dashboard-grid" id="statsGrid">
          <div class="stat-card">
            <div class="stat-card-content">
              <div class="stat-info">
                <div class="stat-label">Solicitudes Pendientes</div>
                <div class="stat-value" id="statPending">-</div>
                <div class="stat-change" id="statPendingChange">Cargando...</div>
              </div>
              <div class="stat-icon">üìã</div>
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-card-content">
              <div class="stat-info">
                <div class="stat-label">Aprobadas</div>
                <div class="stat-value" id="statApproved">-</div>
                <div class="stat-change" id="statApprovedRate">Cargando...</div>
              </div>
              <div class="stat-icon">‚úÖ</div>
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-card-content">
              <div class="stat-info">
                <div class="stat-label">En Proceso</div>
                <div class="stat-value" id="statInProcess">-</div>
                <div class="stat-change" id="statInProcessChange">Cargando...</div>
              </div>
              <div class="stat-icon">‚è≥</div>
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-card-content">
              <div class="stat-info">
                <div class="stat-label">Materiales</div>
                <div class="stat-value" id="statMaterials">-</div>
                <div class="stat-change" id="statMaterialsChange">üì¶ Cat√°logo</div>
              </div>
              <div class="stat-icon">üì¶</div>
            </div>
          </div>
        </div>

        <!-- CHART SECTION -->
        <div class="charts-section">
          <div class="chart-container">
            <h3 class="chart-title">üìà Tendencia de Solicitudes (7 d√≠as)</h3>
            <svg id="trendChart" width="100%" height="200" class="chart-spacer"></svg>
          </div>
          <div class="chart-container">
            <h3 class="chart-title">üéØ Distribuci√≥n de Estados</h3>
            <svg id="statesChart" width="100%" height="200" class="chart-spacer"></svg>
          </div>
        </div>

        <!-- RECENT ACTIVITY -->
        <div class="activity-section">
          <h2 class="section-title">
            <span>üî•</span>
            Actividad Reciente
          </h2>
          <div class="activity-list" id="activityList">
            <div class="activity-loading">
              Cargando actividad...
            </div>
          </div>
        </div>
      </div>

      <!-- PAGE: MIS SOLICITUDES -->
      <div id="page-requests" class="page-content">
        <div class="content-header">
          <h1 class="page-title">Mis Solicitudes</h1>
          <p class="page-subtitle">Visualiza y gestiona tus solicitudes</p>
        </div>
        
        <!-- BORRADORES PENDIENTES -->
        <div id="draftsAlert" class="alert-section" style="display: none; margin-bottom: 20px; padding: 15px; background-color: var(--bg-warning, #fff3cd); border-left: 4px solid var(--warning, #ffc107); border-radius: 4px;">
          <div style="display: flex; align-items: center; gap: 10px;">
            <span style="font-size: 20px;">üíæ</span>
            <div>
              <strong>Borradores Pendientes</strong>
              <p style="margin: 5px 0 0 0; font-size: 14px; color: var(--text-secondary);">
                Tienes <span id="draftCount">0</span> solicitud(es) guardada(s) como borrador que puedes continuar editando.
              </p>
            </div>
          </div>
        </div>
        
        <div class="empty-state">
          <div class="empty-state-icon">üìã</div>
          <h3>Solicitudes</h3>
          <p>En breve podr√°s ver todas tus solicitudes aqu√≠.</p>
          <button class="btn-empty" onclick="navigateTo('new-request')">Crear Nueva Solicitud</button>
        </div>
      </div>

      <!-- PAGE: NUEVA SOLICITUD -->
      <div id="page-new-request" class="page-content new-request-layout">
        <div class="content-header">
          <h1 class="page-title">üìù Nueva Solicitud</h1>
        </div>

        <div class="request-form-wrapper">
          <!-- STEPPER INDICATOR - LATERAL -->
          <div class="form-stepper">
            <div class="stepper-step active" data-step="1">
              <div class="stepper-circle">1</div>
              <span class="stepper-label">Informaci√≥n</span>
            </div>
            <div class="stepper-line"></div>
            <div class="stepper-step" data-step="2">
              <div class="stepper-circle">2</div>
              <span class="stepper-label">Materiales</span>
            </div>
            <div class="stepper-line"></div>
            <div class="stepper-step" data-step="3">
              <div class="stepper-circle">3</div>
              <span class="stepper-label">Confirmar</span>
            </div>
          </div>

          <!-- FORM CONTENT -->
          <div class="form-content-area">

        <!-- FORM STEP 1: INFORMACI√ìN B√ÅSICA -->
        <div id="form-step-1" class="form-step active" data-step-name="info">
          <div class="form-container">
            <div class="form-panel">
              <div class="section-header">
                <div class="section-icon">üìã</div>
                <div>
                  <h2>Informaci√≥n de la Solicitud</h2>
                </div>
              </div>

              <!-- INFO GRID - 2x2 LAYOUT -->
              <div class="form-grid-2x2">
                <div class="form-field">
                  <label for="newReqCentro">Centro <span class="required">*</span></label>
                  <select id="newReqCentro" required onchange="autoFillSector()">
                    <option value="">Seleccione un Centro...</option>
                  </select>
                  <span class="field-hint">Selecciona el Centro Log√≠stico</span>
                </div>

                <div class="form-field">
                  <label for="newReqSector">Sector <span class="required">*</span></label>
                  <input type="text" id="newReqSector" readonly placeholder="Tu sector">
                </div>

                <div class="form-field">
                  <label for="newReqAlmacen">Almac√©n <span class="required">*</span></label>
                  <select id="newReqAlmacen" required>
                    <option value="">Seleccione un Almac√©n...</option>
                  </select>
                  <span class="field-hint">Almac√©n virtual de destino</span>
                </div>

                <div class="form-field">
                  <label for="newReqCriticidad">Criticidad <span class="required">*</span></label>
                  <select id="newReqCriticidad" required>
                    <option value="">Seleccione...</option>
                    <option value="Normal">üü¢ Normal</option>
                    <option value="Alta">üî¥ Alta</option>
                  </select>
                </div>

                <div class="form-field">
                  <label for="newReqFecha">Fecha de Necesidad <span class="required">*</span></label>
                  <input type="date" id="newReqFecha" required>
                </div>

                <div class="form-field">
                  <label for="newReqCostos">Centro de Costos <span class="required">*</span></label>
                  <input type="text" id="newReqCostos" placeholder="">
                </div>
              </div>

              <!-- JUSTIFICACION - FULL WIDTH -->
              <div class="form-field full-width">
                <label for="newReqJustificacion">
                  Justificaci√≥n <span class="required">*</span>
                  <span class="char-counter">(<span id="justCounter">0</span>/250)</span>
                </label>
                <textarea 
                  id="newReqJustificacion" 
                  placeholder="Describe por qu√© necesitas estos materiales..." 
                  maxlength="250"
                  rows="3"
                  required
                  oninput="updateJustCounter()"></textarea>
              </div>
            </div>

            <!-- ACTION BUTTONS -->
            <div class="form-actions-bottom">
              <button type="button" class="btn btn-secondary" onclick="resetForm()">
                üîÑ Limpiar
              </button>
              <button type="button" class="btn btn-secondary" onclick="saveDraft()">
                üíæ Guardar borrador
              </button>
              <button type="button" class="btn btn-primary btn-lg" onclick="navigateFormStep('materials')">
                Continuar
              </button>
            </div>
          </div>
        </div>

        <!-- FORM STEP 2: AGREGAR MATERIALES -->
        <div id="form-step-2" class="form-step" data-step-name="materials" style="display: none;">
          <div class="form-container">
            <div class="form-panel">
              <div class="section-header">
                <div class="section-icon">üì¶</div>
                <div>
                  <h2>Agregar Materiales</h2>
                  <p>Especifica qu√© materiales necesitas y sus cantidades</p>
                </div>
              </div>

              <!-- MATERIAL INPUT SECTION -->
              <div class="material-input-section">
                <!-- SEARCH FILTERS -->
                <div class="material-search-filters">
                  <div class="form-field">
                    <label for="materialSearchSAP">üîç C√≥digo SAP</label>
                    <input type="text" id="materialSearchSAP" placeholder="Buscar por c√≥digo SAP..." oninput="filterMaterials()">
                    <span class="field-hint">Ingresa el c√≥digo SAP del material</span>
                  </div>

                  <div class="form-field">
                    <label for="materialSearchDesc">üìù Descripci√≥n</label>
                    <input type="text" id="materialSearchDesc" placeholder="Buscar por descripci√≥n..." oninput="filterMaterials()">
                    <span class="field-hint">Busca por nombre o descripci√≥n</span>
                  </div>
                </div>

                <!-- MATERIAL SELECTION GRID -->
                <div class="form-grid-materials">
                  <div class="form-field">
                    <label for="materialSelect">Material <span class="required">*</span></label>
                    <select id="materialSelect" required onchange="onMaterialSelected()">
                      <option value="">Selecciona un material...</option>
                    </select>
                    <span class="field-hint">Elige de nuestro cat√°logo</span>
                  </div>

                  <div class="form-field">
                    <label for="materialQuantity">Cantidad <span class="required">*</span></label>
                    <input type="number" id="materialQuantity" min="1" placeholder="0" required>
                    <span class="field-hint">¬øCu√°ntas unidades?</span>
                  </div>

                  <div class="form-field">
                    <label for="materialPrice">Precio Unitario <span class="required">*</span></label>
                    <input type="number" id="materialPrice" min="0" step="0.01" placeholder="0.00" required>
                    <span class="field-hint">Precio por unidad</span>
                  </div>

                  <div class="form-field align-end">
                    <button type="button" class="btn btn-secondary" id="btnViewDescription" style="display: none;" onclick="showMaterialDescription()">
                      üìñ Ver Descripci√≥n
                    </button>
                  </div>

                  <div class="form-field align-end">
                    <button type="button" class="btn btn-success btn-add-material" onclick="addMaterialToList()">
                      ‚ú® Agregar Material
                    </button>
                  </div>
                </div>
              </div>

              <!-- MATERIALS TABLE -->
              <div class="materials-list">
                <div class="materials-header">
                  <h3>üìã Materiales Agregados</h3>
                  <span class="material-count" id="materialCount">0 items</span>
                </div>

                <div class="materials-table-wrapper">
                  <table class="materials-table">
                    <thead>
                      <tr>
                        <th class="col-material">Material</th>
                        <th class="col-qty">Cantidad</th>
                        <th class="col-price">Precio Unit.</th>
                        <th class="col-subtotal">Subtotal</th>
                        <th class="col-action">Acci√≥n</th>
                      </tr>
                    </thead>
                    <tbody id="materialsTableBody">
                      <tr id="no-materials" class="empty-row">
                        <td colspan="5">
                          <div class="empty-materials">
                            <div class="empty-icon">üéÅ</div>
                            <p>A√∫n no has agregado materiales</p>
                            <small>Comienza seleccionando un material arriba</small>
                          </div>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>

                <!-- TOTALS SUMMARY -->
                <div class="materials-summary">
                  <div class="summary-item">
                    <span>Cantidad Total:</span>
                    <strong id="totalQty">0</strong>
                  </div>
                  <div class="summary-divider"></div>
                  <div class="summary-item total">
                    <span>Monto Total:</span>
                    <strong id="totalAmount" class="amount">$0.00</strong>
                  </div>
                </div>
              </div>
            </div>

            <!-- ACTION BUTTONS -->
            <div class="form-actions-bottom">
              <button type="button" class="btn btn-secondary" onclick="navigateFormStep('info')">
                ‚Üê Anterior
              </button>
              <button type="button" class="btn btn-primary btn-lg" onclick="navigateFormStep('review')">
                Siguiente: Revisar ‚Üí
              </button>
            </div>
          </div>
        </div>

        <!-- FORM STEP 3: REVISAR Y CONFIRMAR -->
        <div id="form-step-3" class="form-step" data-step-name="review" style="display: none;">
          <div class="form-container">
            <div class="form-panel">
              <div class="section-header">
                <div class="section-icon">‚úÖ</div>
                <div>
                  <h2>Revisar Solicitud</h2>
                  <p>Verifica todos los datos antes de confirmar</p>
                </div>
              </div>

              <!-- REVIEW SECTION 1: INFO -->
              <div class="review-card">
                <div class="review-card-header">
                  <span class="review-badge">1</span>
                  <h3>Informaci√≥n de la Solicitud</h3>
                </div>
                <div class="review-content">
                  <div class="review-grid-2x3">
                    <div class="review-item">
                      <span class="review-label">üè¢ Centro</span>
                      <span class="review-value" id="reviewCentro">-</span>
                    </div>
                    <div class="review-item">
                      <span class="review-label">üóÇÔ∏è Sector</span>
                      <span class="review-value" id="reviewSector">-</span>
                    </div>
                    <div class="review-item">
                      <span class="review-label">üì¶ Almac√©n</span>
                      <span class="review-value" id="reviewAlmacen">-</span>
                    </div>
                    <div class="review-item">
                      <span class="review-label">üéØ Criticidad</span>
                      <span class="review-value" id="reviewCriticidad">-</span>
                    </div>
                    <div class="review-item">
                      <span class="review-label">üìÖ Fecha Necesaria</span>
                      <span class="review-value" id="reviewFecha">-</span>
                    </div>
                    <div class="review-item">
                      <span class="review-label">üí∞ Centro de Costos</span>
                      <span class="review-value" id="reviewCostos">-</span>
                    </div>
                  </div>
                  <div class="review-full-item">
                    <span class="review-label">üìù Justificaci√≥n</span>
                    <p class="review-value" id="reviewJustificacion">-</p>
                  </div>
                </div>
              </div>

              <!-- REVIEW SECTION 2: MATERIALS -->
              <div class="review-card">
                <div class="review-card-header">
                  <span class="review-badge">2</span>
                  <h3>Materiales</h3>
                </div>
                <div class="review-content">
                  <table class="materials-table materials-table-review">
                    <thead>
                      <tr>
                        <th>Material</th>
                        <th class="text-right">Cantidad</th>
                        <th class="text-right">Precio Unit.</th>
                        <th class="text-right">Subtotal</th>
                      </tr>
                    </thead>
                    <tbody id="reviewMaterialsBody">
                      <tr><td colspan="4" class="text-center">Sin materiales</td></tr>
                    </tbody>
                  </table>
                </div>
              </div>

              <!-- TOTAL SUMMARY -->
              <div class="final-total">
                <div class="total-label">MONTO TOTAL A SOLICITAR</div>
                <div class="total-amount" id="reviewTotal">$0.00</div>
                <div class="total-note">Revisa que toda la informaci√≥n sea correcta antes de confirmar</div>
              </div>

              <!-- ACCESS ALERT (shown if no access) -->
              <div id="accessAlert" style="display: none;">
                <div>
                  ‚ö†Ô∏è Acceso a Centro/Almac√©n Limitado
                </div>
                <div id="accessAlertContent"></div>
                <div class="access-alert-footer">
                  <strong>Lo que suceder√°:</strong> Esta solicitud requerir√° una <strong>aprobaci√≥n adicional</strong> para concederte acceso. Si es aprobada, podr√°s usar este Centro/Almac√©n en futuras solicitudes.
                </div>
              </div>
            </div>

            <!-- ACTION BUTTONS -->
            <div class="form-actions-bottom">
              <button type="button" class="btn btn-secondary" onclick="navigateFormStep('materials')">
                ‚Üê Anterior
              </button>
              <button type="button" class="btn btn-success btn-lg btn-submit" onclick="submitNewRequest()">
                ‚úì Confirmar y Crear Solicitud
              </button>
            </div>
          </div>
        </div>
      </div>

      <style>
        /* ===== FORM STEPPER - VERTICAL VERSION ===== */
        .request-form-wrapper {
          display: flex;
          gap: 28px;
          align-items: flex-start;
          padding: 0 32px 32px 32px;
        }

        .form-stepper {
          display: flex;
          flex-direction: column;
          align-items: flex-start;
          justify-content: flex-start;
          gap: 12px;
          margin-bottom: 0;
          padding: 20px 24px;
          background: var(--bg-primary);
          backdrop-filter: none;
          border-radius: 8px;
          border: 1px solid var(--border-default);
          
          /* Sticky positioning */
          position: sticky;
          top: 80px;
          z-index: 100;
          box-shadow: none;
          animation: none;
          transition: var(--transition);
          position: relative;
          max-width: 220px;
          width: 220px;
          align-self: flex-start;
        }
        
        @keyframes popIn {
          0% {
            opacity: 1;
            transform: none;
            filter: none;
          }
          100% {
            opacity: 1;
            transform: none;
            filter: none;
          }
        }
        
        @keyframes glow {
          0%, 100% {
            box-shadow: none;
          }
          50% {
            box-shadow: none;
          }
        }
        
        .form-stepper.glowing {
          box-shadow: none;
        }
        
        /* Compact mode when scrolling */
        .form-stepper.sticky-compact {
          padding: 12px 20px;
          gap: 8px;
          margin-bottom: 0;
          border-radius: 0;
          top: 64px;
          background: var(--bg-primary);
          border-bottom: 1px solid var(--border-default);
          border-radius: 0;
          box-shadow: 0 8px 25px rgba(124, 58, 237, 0.1);
          width: 180px;
          max-width: 180px;
        }
        
        .form-stepper.sticky-compact .stepper-circle {
          width: 36px;
          height: 36px;
          font-size: 14px;
        }
        
        .form-stepper.sticky-compact .stepper-label {
          font-size: 9px;
          transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .form-stepper.sticky-compact .stepper-line {
          width: 2px;
          height: 16px;
          margin-left: 17px;
        }

        .stepper-step {
          display: flex;
          flex-direction: row;
          align-items: center;
          gap: 12px;
          opacity: 0.45;
          transition: all 0.2s ease;
          position: relative;
          cursor: pointer;
          width: 100%;
        }

        .stepper-step.active {
          opacity: 1;
        }
        
        /* Hover effect en steps no activos */
        .stepper-step:not(.active):hover {
          opacity: 0.8;
        }
        
        .stepper-step:not(.active):hover .stepper-circle {
          border-color: var(--primary);
          box-shadow: none;
          transform: none;
        }

        .stepper-circle {
          width: 48px;
          height: 48px;
          min-width: 48px;
          flex-shrink: 0;
          background: var(--bg-secondary);
          border: 2px solid var(--border-default);
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
          font-weight: 800;
          font-size: 21px;
          color: rgba(148, 163, 184, 0.6);
          transition: all 0.2s ease;
          box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
          position: relative;
          overflow: hidden;
        }
        
        .stepper-circle::before {
          display: none;
        }
        
        /* Ripple effect en click */
        .stepper-circle::after {
          content: '';
          position: absolute;
          top: 50%;
          left: 50%;
          width: 100%;
          height: 100%;
          background: transparent;
          border-radius: 50%;
          transform: none;
          pointer-events: none;
          transition: none;
        }
        
        .stepper-circle:active::after {
          transform: none;
        }
        .stepper-step.active .stepper-circle {
          background: var(--primary);
          border-color: var(--primary);
          color: white;
          box-shadow: none;
          transform: none;
          font-weight: 600;
        }
        
        .stepper-step.active .stepper-circle::before {
          display: none;
        }

        .stepper-label {
          font-size: 12px;
          font-weight: 500;
          color: var(--text-tertiary);
          text-transform: none;
          letter-spacing: 0;
          transition: var(--transition);
          text-align: left;
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
        }
        
        .stepper-step.active .stepper-label {
          color: var(--primary);
          letter-spacing: 0;
          font-size: 12px;
          text-shadow: none;
          font-weight: 600;
        }

        .stepper-line {
          width: 2px;
          height: 24px;
          background: var(--border-default);
          transition: var(--transition);
          border-radius: 1px;
          position: relative;
          margin-left: 22px;
          display: none;
        }
        
        .stepper-line::after {
          content: '';
          position: absolute;
          width: 100%;
          height: 100%;
          background: transparent;
          border-radius: 1px;
        }
        
        .form-stepper.sticky-compact .stepper-line {
          width: 2px;
          height: 16px;
          margin-left: 22px;
        }

        /* ===== FORM CONTAINER ===== */
        .form-container {
          max-width: 900px;
          margin: 0 auto;
        }

        .form-panel {
          background: var(--bg-card);
          border: 1px solid var(--border);
          border-radius: 12px;
          padding: 28px;
          margin-bottom: 24px;
          box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
          transition: var(--transition);
        }

        /* ===== SECTION HEADER ===== */
        .section-header {
          display: flex;
          align-items: flex-start;
          gap: 16px;
          margin-bottom: 32px;
          padding-bottom: 24px;
          border-bottom: 2px solid var(--border);
        }

        .section-icon {
          font-size: 40px;
          line-height: 1;
        }

        .section-header h2 {
          font-size: 24px;
          font-weight: 700;
          color: var(--text-primary);
          margin-bottom: 4px;
        }

        .section-header p {
          font-size: 13px;
          color: var(--text-secondary);
        }

        /* ===== FORM GRID ===== */
        .form-grid-2x2 {
          display: grid;
          grid-template-columns: repeat(2, 1fr);
          gap: 24px;
          margin-bottom: 24px;
        }

        @media (max-width: 768px) {
          .form-grid-2x2 {
            grid-template-columns: 1fr;
          }
        }

        .form-grid-materials {
          display: grid;
          grid-template-columns: 2fr 1fr 1fr auto;
          gap: 16px;
          align-items: flex-end;
          margin-bottom: 28px;
          padding: 20px;
          background: var(--bg-darker);
          border: 1px solid var(--border-light);
          border-radius: 10px;
        }

        @media (max-width: 768px) {
          .form-grid-materials {
            grid-template-columns: 1fr;
          }

          .material-search-filters {
            grid-template-columns: 1fr;
          }
        }

        /* ===== FORM FIELD ===== */
        .form-field {
          display: flex;
          flex-direction: column;
          gap: 4px;
        }

        .form-field.full-width {
          grid-column: 1 / -1;
        }

        .form-field.align-end {
          justify-content: flex-end;
        }

        .form-field label {
          font-size: 12px;
          font-weight: 500;
          color: var(--text-primary);
          text-transform: none;
          letter-spacing: 0;
          display: flex;
          align-items: center;
          justify-content: space-between;
          margin-bottom: 4px;
          transition: var(--transition);
          text-shadow: none;
          filter: none;
        }

        .form-field:hover label {
          color: var(--text-primary);
          filter: none;
          letter-spacing: 0;
        }

        .form-field:focus-within label {
          color: var(--primary);
          filter: none;
          letter-spacing: 0;
        }

        .char-counter {
          font-size: 11px;
          font-weight: 400;
          color: var(--text-tertiary);
          text-transform: none;
          letter-spacing: 0;
          padding: 0;
          background: transparent;
          border-radius: 0;
          border: none;
          transition: var(--transition);
        }

        .form-field:hover .char-counter {
          background: transparent;
          border-color: transparent;
          color: var(--text-secondary);
        }

        .form-field:focus-within .char-counter {
          background: transparent;
          border-color: transparent;
          color: var(--text-secondary);
        }

        .form-field input,
        .form-field select,
        .form-field textarea {
          background: var(--bg-primary);
          border: 1px solid var(--border-default);
          border-radius: 6px;
          color: var(--text-primary);
          padding: 8px 12px;
          font-size: 13px;
          font-family: inherit;
          transition: var(--transition);
          box-shadow: none;
        }

        .form-field input::placeholder,
        .form-field select::placeholder,
        .form-field textarea::placeholder {
          color: var(--text-tertiary);
          opacity: 1;
          transition: var(--transition);
          font-style: normal;
          letter-spacing: 0;
        }

        .form-field input:hover::placeholder,
        .form-field select:hover::placeholder,
        .form-field textarea:hover::placeholder {
          color: var(--text-secondary);
        }

        .form-field input:focus::placeholder,
        .form-field select:focus::placeholder,
        .form-field textarea:focus::placeholder {
          color: var(--text-secondary);
          letter-spacing: 0;
        }

        .form-field input:hover,
        .form-field select:hover,
        .form-field textarea:hover {
          border-color: var(--border-muted);
          box-shadow: none;
        }

        .form-field input:focus,
        .form-field select:focus,
        .form-field textarea:focus {
          outline: none;
          border-color: var(--primary);
          box-shadow: 0 0 0 3px rgba(9, 105, 218, 0.1);
          background: var(--bg-primary);
          transform: none;
        }

        .field-hint {
          font-size: 12px;
          color: var(--text-tertiary);
          font-weight: 400;
          opacity: 1;
          transition: var(--transition);
          display: block;
          margin-top: 3px;
          font-style: normal;
          letter-spacing: 0;
          background: transparent;
          padding: 0;
          border-left: none;
          border-radius: 0;
        }

        .form-field:hover .field-hint {
          opacity: 1;
          border-left-color: transparent;
          background: transparent;
        }

        .form-field:focus-within .field-hint {
          opacity: 1;
          border-left-color: var(--primary);
          color: rgba(148, 163, 184, 1);
        }

        .required {
          color: var(--danger);
          font-weight: 700;
          font-size: 13px;
          margin-left: 4px;
          text-shadow: 0 0 4px rgba(239, 68, 68, 0.2);
          display: inline-block;
        }

        /* Filled state for inputs */
        .form-field input[data-filled="true"],
        .form-field select[data-filled="true"],
        .form-field textarea[data-filled="true"] {
          background: linear-gradient(135deg, rgba(30, 41, 59, 0.85) 0%, rgba(15, 23, 42, 0.85) 100%);
          border-color: rgba(124, 58, 237, 0.3);
          box-shadow: 0 2px 6px rgba(124, 58, 237, 0.08),
                      inset 0 1px 2px rgba(124, 58, 237, 0.12),
                      inset 0 -1px 0 rgba(255, 255, 255, 0.03);
          animation: fieldFill 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .form-field input[data-filled="true"]::placeholder,
        .form-field select[data-filled="true"]::placeholder,
        .form-field textarea[data-filled="true"]::placeholder {
          opacity: 0;
        }

        /* Label glow when input has value */
        .form-field input[data-filled="true"] ~ label,
        .form-field select[data-filled="true"] ~ label,
        .form-field textarea[data-filled="true"] ~ label {
          filter: drop-shadow(0 4px 12px rgba(124, 58, 237, 0.18)) drop-shadow(0 2px 4px rgba(148, 163, 184, 0.1));
          letter-spacing: 0.7px;
        }

        /* Error state for inputs */
        .form-field input.error,
        .form-field select.error,
        .form-field textarea.error {
          border-color: rgba(239, 68, 68, 0.6) !important;
          background: linear-gradient(135deg, rgba(127, 29, 29, 0.1) 0%, rgba(120, 23, 23, 0.1) 100%);
          box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1),
                      0 2px 8px rgba(239, 68, 68, 0.15) !important;
        }

        .form-field input.error:focus,
        .form-field select.error:focus,
        .form-field textarea.error:focus {
          border-color: rgba(239, 68, 68, 0.8) !important;
          box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.2),
                      0 6px 20px rgba(239, 68, 68, 0.2),
                      inset 0 1px 0 rgba(255, 255, 255, 0.05) !important;
        }

        .form-field.error-field label {
          filter: drop-shadow(0 2px 8px rgba(239, 68, 68, 0.3));
          color: rgba(239, 68, 68, 0.8);
        }

        .form-field .error-message {
          font-size: 12px;
          color: var(--danger);
          font-weight: 600;
          margin-top: 6px;
          display: block;
          animation: slideUp 0.3s ease-out;
          letter-spacing: 0.3px;
        }

        /* Loading/Spinner States */
        .loading-spinner {
          display: inline-block;
          width: 16px;
          height: 16px;
          border: 2px solid rgba(124, 58, 237, 0.15);
          border-top-color: var(--primary);
          border-radius: 50%;
          animation: spin 0.8s linear infinite;
        }

        .btn:disabled,
        .btn.loading {
          opacity: 0.7;
          cursor: not-allowed;
          pointer-events: none;
        }

        .btn.loading::before {
          content: '';
          display: inline-block;
          width: 14px;
          height: 14px;
          margin-right: 8px;
          border: 2px solid rgba(255, 255, 255, 0.3);
          border-top-color: white;
          border-radius: 50%;
          animation: spin 0.8s linear infinite;
          vertical-align: middle;
        }

        /* Shimmer loading effect */
        .shimmer-loading {
          background: linear-gradient(
            90deg,
            rgba(124, 58, 237, 0.08) 0%,
            rgba(124, 58, 237, 0.12) 50%,
            rgba(124, 58, 237, 0.08) 100%
          );
          opacity: 0.7;
        }

        /* ===== MATERIAL INPUT SECTION ===== */
        .material-input-section {
          background: var(--bg-darker);
          border: 1px solid var(--border-light);
          border-radius: 10px;
          padding: 20px;
          margin-bottom: 28px;
        }

        /* Material Search Filters */
        .material-search-filters {
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 16px;
          margin-bottom: 24px;
          padding-bottom: 20px;
          border-bottom: 2px solid var(--border-default);
        }

        .material-search-filters .form-field {
          margin-bottom: 0;
        }

        .material-search-filters input[type="text"] {
          background: var(--bg-secondary);
          border: 1px solid var(--border-default);
          color: var(--text-primary);
          padding: 10px 12px;
          border-radius: 6px;
          font-size: 13px;
          transition: var(--transition);
        }

        .material-search-filters input[type="text"]:focus {
          outline: none;
          border-color: var(--primary);
          box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1);
        }

        .material-search-filters input[type="text"]::placeholder {
          color: var(--text-tertiary);
        }

        .btn-add-material {
          height: auto;
          padding: 12px 20px !important;
          white-space: nowrap;
        }

        /* ===== MATERIALS LIST ===== */
        .materials-list {
          margin-top: 28px;
        }

        .materials-header {
          display: flex;
          align-items: center;
          justify-content: space-between;
          margin-bottom: 16px;
        }

        .materials-header h3 {
          font-size: 16px;
          font-weight: 700;
          color: var(--text-primary);
        }

        .material-count {
          font-size: 12px;
          padding: 4px 10px;
          background: rgba(124, 58, 237, 0.15);
          color: var(--primary-light);
          border-radius: 20px;
          font-weight: 600;
        }

        /* ===== MATERIALS TABLE ===== */
        .materials-table-wrapper {
          border: 1px solid var(--border);
          border-radius: 10px;
          overflow: hidden;
          margin-bottom: 16px;
        }

        .materials-table {
          width: 100%;
          border-collapse: collapse;
          background: var(--bg-darker);
        }

        .materials-table thead {
          background: linear-gradient(135deg, rgba(124, 58, 237, 0.12) 0%, rgba(236, 72, 153, 0.05) 100%);
        }

        .materials-table th {
          padding: 14px;
          text-align: left;
          font-weight: 700;
          font-size: 12px;
          color: var(--text-secondary);
          text-transform: uppercase;
          letter-spacing: 0.5px;
          border-bottom: 2px solid var(--border);
        }

        .materials-table td {
          padding: 14px;
          border-bottom: 1px solid var(--border-light);
          font-size: 14px;
          color: var(--text-primary);
        }

        .materials-table tbody tr {
          transition: background-color 0.2s ease;
        }

        .materials-table tbody tr:hover {
          background-color: rgba(99, 102, 241, 0.08);
        }

        .materials-table tbody tr:last-child td {
          border-bottom: none;
        }

        .materials-table .col-material { width: 40%; }
        .materials-table .col-qty { width: 15%; }
        .materials-table .col-price { width: 18%; }
        .materials-table .col-subtotal { width: 18%; }
        .materials-table .col-action { width: 9%; }

        .empty-row td {
          padding: 40px 14px !important;
        }

        .empty-materials {
          display: flex;
          flex-direction: column;
          align-items: center;
          gap: 8px;
          color: var(--text-secondary);
        }

        .empty-icon {
          font-size: 40px;
          opacity: 0.5;
        }

        .empty-materials p {
          font-weight: 600;
          margin: 0;
        }

        .empty-materials small {
          font-size: 12px;
          opacity: 0.7;
        }

        /* ===== MATERIALS SUMMARY ===== */
        .materials-summary {
          display: grid;
          grid-template-columns: 1fr auto 1fr;
          align-items: center;
          gap: 20px;
          padding: 20px;
          background: linear-gradient(135deg, var(--bg-darker) 0%, rgba(124, 58, 237, 0.05) 100%);
          border: 1px solid var(--border-light);
          border-radius: 10px;
          margin-bottom: 0;
        }

        .summary-item {
          display: flex;
          justify-content: space-between;
          align-items: center;
          gap: 12px;
        }

        .summary-item span {
          font-size: 13px;
          font-weight: 600;
          color: var(--text-secondary);
          text-transform: uppercase;
          letter-spacing: 0.3px;
        }

        .summary-item strong {
          font-size: 18px;
          color: var(--text-primary);
        }

        .summary-item.total strong {
          font-size: 24px;
          color: var(--success);
        }

        .summary-divider {
          width: 1px;
          height: 30px;
          background: var(--border);
        }

        /* ===== REVIEW CARDS ===== */
        .review-card {
          background: var(--bg-darker);
          border: 1px solid var(--border);
          border-radius: 10px;
          margin-bottom: 20px;
          overflow: hidden;
        }

        .review-card-header {
          display: flex;
          align-items: center;
          gap: 12px;
          padding: 16px 20px;
          background: linear-gradient(135deg, rgba(124, 58, 237, 0.08) 0%, rgba(236, 72, 153, 0.05) 100%);
          border-bottom: 1px solid var(--border);
        }

        .review-badge {
          display: flex;
          align-items: center;
          justify-content: center;
          width: 32px;
          height: 32px;
          background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
          color: white;
          font-weight: 700;
          border-radius: 50%;
          font-size: 14px;
        }

        .review-card-header h3 {
          font-size: 16px;
          font-weight: 700;
          color: var(--text-primary);
        }

        .review-content {
          padding: 20px;
        }

        .review-grid-2x3 {
          display: grid;
          grid-template-columns: repeat(3, 1fr);
          gap: 20px;
          margin-bottom: 20px;
        }

        @media (max-width: 768px) {
          .review-grid-2x3 {
            grid-template-columns: repeat(2, 1fr);
          }
        }

        .review-item {
          display: flex;
          flex-direction: column;
          gap: 6px;
          padding-bottom: 12px;
          border-bottom: 1px solid var(--border-light);
        }

        .review-label {
          font-size: 12px;
          font-weight: 700;
          color: var(--text-secondary);
          text-transform: uppercase;
          letter-spacing: 0.3px;
        }

        .review-value {
          font-size: 14px;
          font-weight: 600;
          color: var(--text-primary);
        }

        .review-full-item {
          margin-top: 16px;
          padding-top: 16px;
          border-top: 1px solid var(--border-light);
        }

        .review-full-item .review-label {
          margin-bottom: 8px;
        }

        .review-full-item p {
          font-size: 14px;
          color: var(--text-primary);
          line-height: 1.6;
          margin: 0;
        }

        .materials-table-review tbody tr:hover {
          background-color: transparent;
        }

        /* ===== FINAL TOTAL ===== */
        .final-total {
          text-align: center;
          padding: 28px;
          background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(124, 58, 237, 0.05) 100%);
          border: 2px solid var(--success);
          border-radius: 12px;
          margin-top: 24px;
          margin-bottom: 24px;
        }

        .total-label {
          font-size: 12px;
          font-weight: 700;
          color: var(--text-secondary);
          text-transform: uppercase;
          letter-spacing: 1px;
          margin-bottom: 12px;
        }

        .total-amount {
          font-size: 42px;
          font-weight: 700;
          background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
          -webkit-background-clip: text;
          -webkit-text-fill-color: transparent;
          background-clip: text;
          margin-bottom: 8px;
        }

        .total-note {
          font-size: 12px;
          color: var(--text-secondary);
          font-style: italic;
        }

        /* ===== ACCESS ALERT ===== */
        #accessAlert {
          margin-top: 20px;
          padding: 15px;
          background-color: #fef3c7;
          border-left: 4px solid #f59e0b;
          border-radius: 4px;
        }

        #accessAlert > div:first-child {
          color: #92400e;
          font-weight: bold;
          margin-bottom: 8px;
        }

        #accessAlert #accessAlertContent {
          color: #b45309;
          font-size: 14px;
          line-height: 1.5;
        }

        #accessAlert .access-alert-footer {
          margin-top: 10px;
          padding-top: 10px;
          border-top: 1px solid #f5d547;
          color: #b45309;
        }

        /* ===== FORM ACTIONS ===== */
        .form-actions-bottom {
          display: flex;
          gap: 12px;
          justify-content: flex-end;
          align-items: center;
        }

        .form-actions-bottom .btn {
          min-width: 150px;
        }

        /* ===== BUTTONS ===== */
        .btn {
          padding: 10px 16px;
          border: 1px solid var(--border-default);
          border-radius: 6px;
          font-weight: 500;
          cursor: pointer;
          transition: var(--transition);
          font-size: 12px;
          display: inline-flex;
          align-items: center;
          justify-content: center;
          gap: 6px;
          position: relative;
          overflow: visible;
          background: var(--bg-secondary);
          color: var(--text-primary);
        }
        
        .btn:hover {
          background: var(--bg-tertiary);
          border-color: var(--border-muted);
        }

        .btn:active {
          background: var(--bg-tertiary);
        }

        .btn-lg {
          padding: 12px 20px !important;
          font-size: 13px !important;
        }

        .btn-primary {
          background: var(--primary);
          color: white;
          border: 1px solid var(--primary-dark);
        }

        .btn-primary:hover {
          background: var(--primary-dark);
          border-color: var(--primary-dark);
        }

        .btn-primary:active {
          background: var(--primary-dark);
        }

        .btn-secondary {
          background: var(--bg-secondary);
          color: var(--text-primary);
          border: 1px solid var(--border-default);
        }

        .btn-secondary:hover {
          background: var(--bg-tertiary);
          border-color: var(--border-muted);
        }

        .btn-secondary:active {
          background: var(--bg-tertiary);
        }

        .btn-success {
          background: var(--success);
          color: white;
          border: 1px solid var(--success);
        }

        .btn-success:hover {
          background: var(--success-light);
          border-color: var(--success-light);
        }

        .btn-success:active {
          background: var(--success);
        }

        .btn-submit {
          min-width: 250px;
        }

        /* ===== MODAL STYLES ===== */
        .modal-backdrop {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.6);
          display: flex;
          align-items: center;
          justify-content: center;
          z-index: 10000;
          backdrop-filter: blur(2px);
          animation: fadeIn 0.2s ease-out;
        }

        @keyframes fadeIn {
          from {
            opacity: 0;
          }
          to {
            opacity: 1;
          }
        }

        .modal-content {
          background: var(--bg-primary);
          border: 1px solid var(--border-default);
          border-radius: 12px;
          box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
          max-width: 600px;
          width: 90%;
          max-height: 80vh;
          overflow-y: auto;
          animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
          from {
            transform: translateY(20px);
            opacity: 0;
          }
          to {
            transform: translateY(0);
            opacity: 1;
          }
        }

        .modal-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 24px;
          border-bottom: 1px solid var(--border-default);
          background: var(--bg-secondary);
        }

        .modal-header h2 {
          margin: 0;
          color: var(--text-primary);
          font-size: 18px;
          font-weight: 600;
        }

        .btn-close {
          background: none;
          border: none;
          color: var(--text-secondary);
          font-size: 24px;
          cursor: pointer;
          padding: 0;
          width: 32px;
          height: 32px;
          display: flex;
          align-items: center;
          justify-content: center;
          border-radius: 6px;
          transition: var(--transition);
        }

        .btn-close:hover {
          background: var(--bg-tertiary);
          color: var(--text-primary);
        }

        .modal-body {
          padding: 24px;
        }

        .desc-field {
          margin-bottom: 20px;
        }

        .desc-field:last-child {
          margin-bottom: 0;
        }

        .desc-field label {
          display: block;
          font-weight: 600;
          color: var(--text-primary);
          margin-bottom: 8px;
          font-size: 13px;
          text-transform: uppercase;
          letter-spacing: 0.5px;
        }

        .desc-field p {
          margin: 0;
          color: var(--text-secondary);
          padding: 12px;
          background: var(--bg-secondary);
          border-radius: 6px;
          border: 1px solid var(--border-default);
          font-size: 14px;
          line-height: 1.5;
          word-wrap: break-word;
        }

        .modal-footer {
          display: flex;
          gap: 12px;
          justify-content: flex-end;
          padding: 20px 24px;
          border-top: 1px solid var(--border-default);
          background: var(--bg-secondary);
        }

        .modal-footer .btn {
          padding: 10px 20px;
          font-size: 14px;
        }

        /* ===== STEP ANIMATION ===== */
        .form-step {
          animation: slideInFade 0.4s ease-out;
        }

        @keyframes slideInFade {
          from {
            opacity: 0;
            transform: translateY(10px);
          }
          to {
            opacity: 1;
            transform: translateY(0);
          }
        }

        /* ===== UTILITY ===== */
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .text-muted { color: var(--text-secondary); }
      </style>

      <!-- PAGE: AGREGAR MATERIALES -->
      <div id="page-add-materials" class="page-content">
        <div class="content-header">
          <h1 class="page-title">üì¶ Agregar Materiales</h1>
          <p class="page-subtitle">Busca y a√±ade materiales a tu solicitud</p>
        </div>

        <div style="background: var(--bg-primary); border-radius: 12px; padding: 24px; border: 1px solid var(--border-default);">
          <!-- Search Section -->
          <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 16px; margin-bottom: 24px; align-items: flex-end;">
            <div>
              <label style="display: block; font-weight: 500; margin-bottom: 8px; color: var(--text-primary);">C√≥digo SAP</label>
              <input id="codeSearch" type="text" placeholder="Ej: 1000000006" autocomplete="off" 
                style="width: 100%; padding: 10px 12px; background: var(--bg-secondary); border: 1px solid var(--border-default); border-radius: 6px; color: var(--text-primary);" />
              <div id="suggestCode" class="suggest" style="display: none; position: absolute; background: var(--bg-secondary); border: 1px solid var(--border-default); border-radius: 6px; z-index: 1000; max-height: 300px; overflow-y: auto; width: 290px;"></div>
            </div>

            <div>
              <label style="display: block; font-weight: 500; margin-bottom: 8px; color: var(--text-primary);">Descripci√≥n</label>
              <input id="descSearch" type="text" placeholder="Descripci√≥n del material" autocomplete="off" 
                style="width: 100%; padding: 10px 12px; background: var(--bg-secondary); border: 1px solid var(--border-default); border-radius: 6px; color: var(--text-primary);" />
              <div id="suggestDesc" class="suggest" style="display: none; position: absolute; background: var(--bg-secondary); border: 1px solid var(--border-default); border-radius: 6px; z-index: 1000; max-height: 300px; overflow-y: auto; width: 290px;"></div>
            </div>

            <div>
              <button id="btnShowMaterialDetail" style="padding: 10px 16px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; disabled: true;" disabled>
                Ver detalle
              </button>
            </div>
          </div>

          <!-- Add Button -->
          <button id="btnAdd" style="padding: 12px 24px; background: var(--success); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; margin-bottom: 24px;">
            ‚ûï Agregar √≠tem
          </button>

          <!-- Materials Table -->
          <div style="overflow-x: auto;">
            <table id="tbl" style="width: 100%; border-collapse: collapse; color: var(--text-primary);">
              <thead style="background: var(--bg-secondary); border-bottom: 2px solid var(--border-default);">
                <tr>
                  <th style="padding: 12px; text-align: left;">C√≥digo</th>
                  <th style="padding: 12px; text-align: left;">Descripci√≥n</th>
                  <th style="padding: 12px; text-align: center;">Unidad</th>
                  <th style="padding: 12px; text-align: right;">Precio unitario</th>
                  <th style="padding: 12px; text-align: center;">Cantidad</th>
                  <th style="padding: 12px; text-align: right;">Total</th>
                  <th style="padding: 12px; text-align: center;">Acci√≥n</th>
                </tr>
              </thead>
              <tbody style="border-top: 1px solid var(--border-default);"></tbody>
            </table>
          </div>

          <!-- Total -->
          <div style="margin-top: 24px; padding: 16px; background: var(--bg-secondary); border-radius: 6px; display: flex; justify-content: flex-end; gap: 8px; align-items: center;">
            <span style="font-weight: 500; color: var(--text-secondary);">Total estimado:</span>
            <strong id="cartTotal" style="font-size: 18px; color: var(--success);">$0,00</strong>
          </div>
        </div>
      </div>

      <!-- PAGE: PLANIFICACI√ìN -->
      <div id="page-planner" class="page-content">
        <div class="content-header">
          <h1 class="page-title">üóÇÔ∏è Gesti√≥n de Planificaci√≥n</h1>
          <p class="page-subtitle">Abastecimiento optimizado de solicitudes de materiales</p>
        </div>

        <!-- ESTAD√çSTICAS -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
          <div style="background: linear-gradient(135deg, #262d48 0%, #37415d 100%); border: 1px solid #2d3342; border-radius: 0.75rem; padding: 1.5rem; transition: all 0.3s ease; cursor: pointer;" onmouseover="this.style.borderColor='#7c3aed'; this.style.transform='translateY(-4px)'" onmouseout="this.style.borderColor='#2d3342'; this.style.transform='none'">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 1rem;">
              <div style="flex: 1;">
                <div style="font-size: 0.875rem; color: #d1d5db; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.5rem;">Pendientes</div>
                <div style="font-size: 2rem; font-weight: 700; color: #f3f4f6;" id="statPending">0</div>
              </div>
              <div style="font-size: 2rem; opacity: 0.5;">‚è≥</div>
            </div>
          </div>
          <div style="background: linear-gradient(135deg, #262d48 0%, #37415d 100%); border: 1px solid #2d3342; border-radius: 0.75rem; padding: 1.5rem; transition: all 0.3s ease; cursor: pointer;" onmouseover="this.style.borderColor='#7c3aed'; this.style.transform='translateY(-4px)'" onmouseout="this.style.borderColor='#2d3342'; this.style.transform='none'">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 1rem;">
              <div style="flex: 1;">
                <div style="font-size: 0.875rem; color: #d1d5db; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.5rem;">En Proceso</div>
                <div style="font-size: 2rem; font-weight: 700; color: #f3f4f6;" id="statInProcess">0</div>
              </div>
              <div style="font-size: 2rem; opacity: 0.5;">‚öôÔ∏è</div>
            </div>
          </div>
          <div style="background: linear-gradient(135deg, #262d48 0%, #37415d 100%); border: 1px solid #2d3342; border-radius: 0.75rem; padding: 1.5rem; transition: all 0.3s ease; cursor: pointer;" onmouseover="this.style.borderColor='#7c3aed'; this.style.transform='translateY(-4px)'" onmouseout="this.style.borderColor='#2d3342'; this.style.transform='none'">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 1rem;">
              <div style="flex: 1;">
                <div style="font-size: 0.875rem; color: #d1d5db; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.5rem;">Optimizadas</div>
                <div style="font-size: 2rem; font-weight: 700; color: #f3f4f6;" id="statOptimized">0</div>
              </div>
              <div style="font-size: 2rem; opacity: 0.5;">‚ú®</div>
            </div>
          </div>
          <div style="background: linear-gradient(135deg, #262d48 0%, #37415d 100%); border: 1px solid #2d3342; border-radius: 0.75rem; padding: 1.5rem; transition: all 0.3s ease; cursor: pointer;" onmouseover="this.style.borderColor='#7c3aed'; this.style.transform='translateY(-4px)'" onmouseout="this.style.borderColor='#2d3342'; this.style.transform='none'">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 1rem;">
              <div style="flex: 1;">
                <div style="font-size: 0.875rem; color: #d1d5db; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.5rem;">Completadas</div>
                <div style="font-size: 2rem; font-weight: 700; color: #f3f4f6;" id="statCompleted">0</div>
              </div>
              <div style="font-size: 2rem; opacity: 0.5;">‚úÖ</div>
            </div>
          </div>
        </div>

        <!-- TABLA DE SOLICITUDES -->
        <div style="background: linear-gradient(135deg, #262d48 0%, #37415d 100%); border: 1px solid #2d3342; border-radius: 0.75rem; padding: 2rem; margin-bottom: 2rem; backdrop-filter: blur(10px);">
          <h2 style="font-size: 1.25rem; font-weight: 700; color: #f3f4f6; margin: 0 0 1.5rem 0; display: flex; align-items: center; gap: 0.5rem;">üìã Solicitudes por Procesar</h2>
          
          <div style="overflow-x: auto; margin-bottom: 1.5rem; border-radius: 0.5rem; border: 1px solid #2d3342;">
            <table style="width: 100%; border-collapse: collapse; background: rgba(15, 23, 42, 0.6);" id="solicitudesTable">
              <thead style="background: rgba(15, 23, 42, 0.8); border-bottom: 2px solid #2d3342;">
                <tr>
                  <th style="padding: 1rem; text-align: left; font-weight: 600; color: #d1d5db; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.05em;">ID</th>
                  <th style="padding: 1rem; text-align: left; font-weight: 600; color: #d1d5db; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.05em;">Centro</th>
                  <th style="padding: 1rem; text-align: left; font-weight: 600; color: #d1d5db; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.05em;">Sector</th>
                  <th style="padding: 1rem; text-align: left; font-weight: 600; color: #d1d5db; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.05em;">Criticidad</th>
                  <th style="padding: 1rem; text-align: left; font-weight: 600; color: #d1d5db; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.05em;">Items</th>
                  <th style="padding: 1rem; text-align: left; font-weight: 600; color: #d1d5db; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.05em;">Monto</th>
                  <th style="padding: 1rem; text-align: left; font-weight: 600; color: #d1d5db; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.05em;">Estado</th>
                  <th style="padding: 1rem; text-align: left; font-weight: 600; color: #d1d5db; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.05em;">Acciones</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td colspan="8" style="padding: 2rem; text-align: center; color: #d1d5db;">Cargando solicitudes...</td>
                </tr>
              </tbody>
            </table>
          </div>

          <div style="display: flex; gap: 1rem; justify-content: center; align-items: center; padding: 1rem 0;">
            <button class="btn" id="btnPrevPage" disabled style="opacity: 0.5; cursor: not-allowed;">‚óÄ Anterior</button>
            <span id="pageInfo" style="color: #d1d5db; font-size: 0.9rem;">P√°gina 1</span>
            <button class="btn" id="btnNextPage" disabled style="opacity: 0.5; cursor: not-allowed;">Siguiente ‚ñ∂</button>
          </div>
        </div>

        <!-- PANEL DE DETALLES (OCULTO POR DEFECTO) -->
        <div id="detailPanel" class="page-content" hidden style="background: linear-gradient(135deg, #262d48 0%, #37415d 100%); border: 1px solid #2d3342; border-radius: 0.75rem; padding: 2rem; margin-bottom: 2rem; backdrop-filter: blur(10px);">
          <div style="display: flex; justify-content: space-between; align-items: center; gap: 1rem; margin-bottom: 1.5rem;">
            <h2 style="font-size: 1.25rem; font-weight: 700; color: #f3f4f6; margin: 0; display: flex; align-items: center; gap: 0.5rem;">üìÑ Detalles de Solicitud <span id="detailSolicitudId"></span></h2>
            <button class="btn" id="btnCloseDetail" style="margin-left: auto;">‚úï Cerrar</button>
          </div>

          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
            <div style="padding: 1rem; background: rgba(15, 23, 42, 0.6); border-radius: 0.5rem; border: 1px solid #2d3342;">
              <label style="font-size: 0.75rem; color: #d1d5db; text-transform: uppercase; letter-spacing: 0.05em; margin: 0 0 0.5rem 0; display: block;">Centro</label>
              <div style="font-size: 1rem; color: #f3f4f6; font-weight: 500;" id="detailCentro">‚Äî</div>
            </div>
            <div style="padding: 1rem; background: rgba(15, 23, 42, 0.6); border-radius: 0.5rem; border: 1px solid #2d3342;">
              <label style="font-size: 0.75rem; color: #d1d5db; text-transform: uppercase; letter-spacing: 0.05em; margin: 0 0 0.5rem 0; display: block;">Sector</label>
              <div style="font-size: 1rem; color: #f3f4f6; font-weight: 500;" id="detailSector">‚Äî</div>
            </div>
            <div style="padding: 1rem; background: rgba(15, 23, 42, 0.6); border-radius: 0.5rem; border: 1px solid #2d3342;">
              <label style="font-size: 0.75rem; color: #d1d5db; text-transform: uppercase; letter-spacing: 0.05em; margin: 0 0 0.5rem 0; display: block;">Criticidad</label>
              <div style="font-size: 1rem; color: #f3f4f6; font-weight: 500;" id="detailCriticidad">‚Äî</div>
            </div>
            <div style="padding: 1rem; background: rgba(15, 23, 42, 0.6); border-radius: 0.5rem; border: 1px solid #2d3342;">
              <label style="font-size: 0.75rem; color: #d1d5db; text-transform: uppercase; letter-spacing: 0.05em; margin: 0 0 0.5rem 0; display: block;">Estado</label>
              <div style="font-size: 1rem; color: #f3f4f6; font-weight: 500;" id="detailEstado">‚Äî</div>
            </div>
            <div style="padding: 1rem; background: rgba(15, 23, 42, 0.6); border-radius: 0.5rem; border: 1px solid #2d3342;">
              <label style="font-size: 0.75rem; color: #d1d5db; text-transform: uppercase; letter-spacing: 0.05em; margin: 0 0 0.5rem 0; display: block;">Total</label>
              <div style="font-size: 1rem; color: #f3f4f6; font-weight: 500;" id="detailTotal">‚Äî</div>
            </div>
          </div>

          <h3 style="margin-top: 2rem; margin-bottom: 1rem; font-size: 1.1rem; color: #f3f4f6;">üìä An√°lisis de Optimizaci√≥n</h3>
          <div style="background: rgba(15, 23, 42, 0.8); padding: 1.5rem; border-radius: 0.5rem; border-left: 3px solid #7c3aed;" id="optimizationResults">
            <p style="margin: 0.5rem 0; font-size: 0.95rem; color: #d1d5db;">Cargando an√°lisis...</p>
          </div>

          <h3 style="margin-top: 2rem; margin-bottom: 1rem; font-size: 1.1rem; color: #f3f4f6;">üì¶ Materiales</h3>
          <div style="overflow-x: auto; margin-bottom: 1.5rem; border-radius: 0.5rem; border: 1px solid #2d3342;">
            <table style="width: 100%; border-collapse: collapse; background: rgba(15, 23, 42, 0.6);">
              <thead style="background: rgba(15, 23, 42, 0.8); border-bottom: 2px solid #2d3342;">
                <tr>
                  <th style="padding: 1rem; text-align: left; font-weight: 600; color: #d1d5db; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.05em;">C√≥digo</th>
                  <th style="padding: 1rem; text-align: left; font-weight: 600; color: #d1d5db; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.05em;">Descripci√≥n</th>
                  <th style="padding: 1rem; text-align: left; font-weight: 600; color: #d1d5db; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.05em;">Cantidad</th>
                  <th style="padding: 1rem; text-align: left; font-weight: 600; color: #d1d5db; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.05em;">Unidad</th>
                  <th style="padding: 1rem; text-align: left; font-weight: 600; color: #d1d5db; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.05em;">Precio Unit.</th>
                  <th style="padding: 1rem; text-align: left; font-weight: 600; color: #d1d5db; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.05em;">Total</th>
                </tr>
              </thead>
              <tbody id="detailMateriales">
                <tr>
                  <td colspan="6" style="padding: 1rem; text-align: center; color: #d1d5db;">Cargando materiales...</td>
                </tr>
              </tbody>
            </table>
          </div>

          <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
            <button class="btn" id="btnOptimize">‚ú® Optimizar Solicitud</button>
          </div>
        </div>
      </div>

      <!-- PAGE: NOTIFICACIONES -->
      <div id="page-notifications" class="page-content">
        <div class="content-header">
          <h1 class="page-title">üîî Notificaciones</h1>
          <p class="page-subtitle">Mantente actualizado con tus notificaciones</p>
        </div>
        <div style="display: grid; gap: 1rem; padding: 1.5rem 0;">
          <!-- Notification Item 1 -->
          <div style="background: linear-gradient(135deg, #262d48 0%, #37415d 100%); border: 1px solid #2d3342; border-left: 4px solid #10b981; border-radius: 0.75rem; padding: 1.25rem; transition: all 0.3s ease; cursor: pointer;" onmouseover="this.style.borderLeftColor='#3b82f6'" onmouseout="this.style.borderLeftColor='#10b981'">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 1rem;">
              <div style="flex: 1;">
                <div style="font-size: 0.875rem; color: #60a5fa; font-weight: 600; margin-bottom: 0.5rem;">‚úÖ Solicitud Aprobada</div>
                <div style="font-size: 0.95rem; color: #f3f4f6; margin-bottom: 0.5rem;">Tu solicitud #1234 ha sido aprobada</div>
                <div style="font-size: 0.8rem; color: #9ca3af;">Hace 2 horas</div>
              </div>
              <div style="background: #10b981; padding: 0.5rem; border-radius: 0.5rem; color: white;">‚úì</div>
            </div>
          </div>
          <!-- Notification Item 2 -->
          <div style="background: linear-gradient(135deg, #262d48 0%, #37415d 100%); border: 1px solid #2d3342; border-left: 4px solid #f59e0b; border-radius: 0.75rem; padding: 1.25rem; transition: all 0.3s ease; cursor: pointer;" onmouseover="this.style.borderLeftColor='#3b82f6'" onmouseout="this.style.borderLeftColor='#f59e0b'">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 1rem;">
              <div style="flex: 1;">
                <div style="font-size: 0.875rem; color: #fbbf24; font-weight: 600; margin-bottom: 0.5rem;">‚ö†Ô∏è Requiere Revisi√≥n</div>
                <div style="font-size: 0.95rem; color: #f3f4f6; margin-bottom: 0.5rem;">La solicitud #1232 requiere revisi√≥n de documentaci√≥n</div>
                <div style="font-size: 0.8rem; color: #9ca3af;">Hace 6 horas</div>
              </div>
              <div style="background: #f59e0b; padding: 0.5rem; border-radius: 0.5rem; color: white;">!</div>
            </div>
          </div>
          <!-- Notification Item 3 -->
          <div style="background: linear-gradient(135deg, #262d48 0%, #37415d 100%); border: 1px solid #2d3342; border-left: 4px solid #3b82f6; border-radius: 0.75rem; padding: 1.25rem; transition: all 0.3s ease; cursor: pointer;" onmouseover="this.style.borderLeftColor='#10b981'" onmouseout="this.style.borderLeftColor='#3b82f6'">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 1rem;">
              <div style="flex: 1;">
                <div style="font-size: 0.875rem; color: #60a5fa; font-weight: 600; margin-bottom: 0.5rem;">‚ÑπÔ∏è Informaci√≥n del Sistema</div>
                <div style="font-size: 0.95rem; color: #f3f4f6; margin-bottom: 0.5rem;">Se ha iniciado sesi√≥n desde otro dispositivo</div>
                <div style="font-size: 0.8rem; color: #9ca3af;">Hace 1 d√≠a</div>
              </div>
              <div style="background: #3b82f6; padding: 0.5rem; border-radius: 0.5rem; color: white;">i</div>
            </div>
          </div>
        </div>
      </div>

      <!-- PAGE: USUARIOS (Admin) -->
      <div id="page-users" class="page-content">
        <div class="content-header">
          <h1 class="page-title">Gesti√≥n de Usuarios</h1>
          <p class="page-subtitle">Administra los usuarios del sistema</p>
        </div>
        <div class="empty-state">
          <div class="empty-state-icon">üë•</div>
          <h3>Usuarios</h3>
          <p>La gesti√≥n de usuarios estar√° disponible pronto.</p>
        </div>
      </div>

      <!-- PAGE: MATERIALES (Admin) -->
      <div id="page-materials" class="page-content">
        <div class="content-header">
          <h1 class="page-title">Cat√°logo de Materiales</h1>
          <p class="page-subtitle">Administra el cat√°logo de materiales disponibles</p>
        </div>
        <div class="empty-state">
          <div class="empty-state-icon">üì¶</div>
          <h3>Materiales</h3>
          <p>El cat√°logo de materiales estar√° disponible pronto.</p>
        </div>
      </div>

      <!-- PAGE: CENTROS (Admin) -->
      <div id="page-centers" class="page-content">
        <div class="content-header">
          <h1 class="page-title">Gesti√≥n de Centros</h1>
          <p class="page-subtitle">Administra los centros de distribuci√≥n</p>
        </div>
        <div class="empty-state">
          <div class="empty-state-icon">üè¢</div>
          <h3>Centros</h3>
          <p>La gesti√≥n de centros estar√° disponible pronto.</p>
        </div>
      </div>

      <!-- PAGE: ALMACENES (Admin) -->
      <div id="page-warehouses" class="page-content">
        <div class="content-header">
          <h1 class="page-title">Gesti√≥n de Almacenes</h1>
          <p class="page-subtitle">Administra los almacenes disponibles</p>
        </div>
        <div class="empty-state">
          <div class="empty-state-icon">üè≠</div>
          <h3>Almacenes</h3>
          <p>La gesti√≥n de almacenes estar√° disponible pronto.</p>
        </div>
      </div>

      <!-- PAGE: REPORTES (Admin) -->
      <div id="page-reports" class="page-content">
        <div class="content-header">
          <h1 class="page-title">Reportes</h1>
          <p class="page-subtitle">Visualiza reportes y an√°lisis del sistema</p>
        </div>
        <div class="empty-state">
          <div class="empty-state-icon">üìä</div>
          <h3>Reportes</h3>
          <p>Los reportes estar√°n disponibles pronto.</p>
        </div>
      </div>

      <!-- PAGE: PREFERENCIAS -->
      <div id="page-preferences" class="page-content">
        <div class="content-header">
          <h1 class="page-title">‚öôÔ∏è Preferencias</h1>
          <p class="page-subtitle">Personaliza tu experiencia en SPM</p>
        </div>
        <div style="max-width: 600px; background: linear-gradient(135deg, #262d48 0%, #37415d 100%); border: 1px solid #2d3342; border-radius: 0.75rem; padding: 2rem; margin-top: 2rem;">
          <!-- Tema -->
          <div style="margin-bottom: 2rem; border-bottom: 1px solid #2d3342; padding-bottom: 2rem;">
            <h3 style="color: #f3f4f6; margin: 0 0 1rem 0; font-size: 1rem; font-weight: 600;">üé® Tema</h3>
            <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer; color: #d1d5db;">
              <input type="radio" name="theme" value="dark" checked style="cursor: pointer;">
              <span>Modo Oscuro (Recomendado)</span>
            </label>
            <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer; color: #d1d5db; margin-top: 0.75rem;">
              <input type="radio" name="theme" value="light" style="cursor: pointer;">
              <span>Modo Claro</span>
            </label>
          </div>
          <!-- Notificaciones -->
          <div style="margin-bottom: 2rem; border-bottom: 1px solid #2d3342; padding-bottom: 2rem;">
            <h3 style="color: #f3f4f6; margin: 0 0 1rem 0; font-size: 1rem; font-weight: 600;">üîî Notificaciones</h3>
            <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer; color: #d1d5db;">
              <input type="checkbox" checked style="cursor: pointer;">
              <span>Notificaciones de solicitudes</span>
            </label>
            <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer; color: #d1d5db; margin-top: 0.75rem;">
              <input type="checkbox" checked style="cursor: pointer;">
              <span>Notificaciones de cambios</span>
            </label>
            <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer; color: #d1d5db; margin-top: 0.75rem;">
              <input type="checkbox" style="cursor: pointer;">
              <span>Notificaciones por email</span>
            </label>
          </div>
          <!-- Seguridad -->
          <div style="margin-bottom: 2rem;">
            <h3 style="color: #f3f4f6; margin: 0 0 1rem 0; font-size: 1rem; font-weight: 600;">üîê Seguridad</h3>
            <button style="padding: 0.75rem 1.5rem; background: var(--primary); color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-weight: 500;">Cambiar Contrase√±a</button>
            <div style="color: #9ca3af; font-size: 0.875rem; margin-top: 1rem;">
              ‚úì Autenticaci√≥n de dos factores: Disponible
            </div>
          </div>
          <!-- Botones -->
          <div style="display: flex; gap: 1rem; margin-top: 2rem;">
            <button style="padding: 0.75rem 1.5rem; background: var(--primary); color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-weight: 500;">Guardar Cambios</button>
            <button style="padding: 0.75rem 1.5rem; background: #2d3342; color: #d1d5db; border: 1px solid #3d4450; border-radius: 0.5rem; cursor: pointer; font-weight: 500;">Cancelar</button>
          </div>
        </div>
      </div>

      <!-- PAGE: AYUDA -->
      <div id="page-help" class="page-content">
        <div class="content-header">
          <h1 class="page-title">‚ùì Centro de Ayuda</h1>
          <p class="page-subtitle">Preguntas frecuentes y soporte</p>
        </div>
        <div style="display: grid; gap: 1.5rem; margin-top: 2rem;">
          <!-- FAQ Item 1 -->
          <div style="background: linear-gradient(135deg, #262d48 0%, #37415d 100%); border: 1px solid #2d3342; border-radius: 0.75rem; overflow: hidden;">
            <div style="padding: 1.5rem; cursor: pointer; transition: all 0.3s;" onclick="this.parentElement.classList.toggle('expanded'); this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none';">
              <h3 style="color: #f3f4f6; margin: 0; font-size: 1rem; font-weight: 600;">¬øC√≥mo crear una nueva solicitud?</h3>
              <span style="color: #9ca3af; font-size: 0.875rem;">Gu√≠a paso a paso</span>
            </div>
            <div style="padding: 0 1.5rem 1.5rem 1.5rem; color: #d1d5db; font-size: 0.95rem; display: none; border-top: 1px solid #2d3342;">
              1. Dir√≠gete a "Nueva Solicitud" en el men√∫<br>
              2. Completa los campos requeridos<br>
              3. Adjunta los materiales necesarios<br>
              4. Env√≠a para aprobaci√≥n
            </div>
          </div>
          <!-- FAQ Item 2 -->
          <div style="background: linear-gradient(135deg, #262d48 0%, #37415d 100%); border: 1px solid #2d3342; border-radius: 0.75rem; overflow: hidden;">
            <div style="padding: 1.5rem; cursor: pointer; transition: all 0.3s;" onclick="this.parentElement.classList.toggle('expanded'); this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none';">
              <h3 style="color: #f3f4f6; margin: 0; font-size: 1rem; font-weight: 600;">¬øC√≥mo agregar materiales?</h3>
              <span style="color: #9ca3af; font-size: 0.875rem;">Gesti√≥n del cat√°logo</span>
            </div>
            <div style="padding: 0 1.5rem 1.5rem 1.5rem; color: #d1d5db; font-size: 0.95rem; display: none; border-top: 1px solid #2d3342;">
              Accede a "Agregar Materiales" desde el men√∫, ingresa los datos del material, asigna c√≥digos y cantidades disponibles, luego guarda en el sistema.
            </div>
          </div>
          <!-- FAQ Item 3 -->
          <div style="background: linear-gradient(135deg, #262d48 0%, #37415d 100%); border: 1px solid #2d3342; border-radius: 0.75rem; overflow: hidden;">
            <div style="padding: 1.5rem; cursor: pointer; transition: all 0.3s;" onclick="this.parentElement.classList.toggle('expanded'); this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none';">
              <h3 style="color: #f3f4f6; margin: 0; font-size: 1rem; font-weight: 600;">¬øC√≥mo aceptar solicitudes como planificador?</h3>
              <span style="color: #9ca3af; font-size: 0.875rem;">Rol de Planificador</span>
            </div>
            <div style="padding: 0 1.5rem 1.5rem 1.5rem; color: #d1d5db; font-size: 0.95rem; display: none; border-top: 1px solid #2d3342;">
              En la secci√≥n "Planificaci√≥n", ver√°s todas las solicitudes pendientes. Revisa los detalles, valida disponibilidad de materiales y haz clic en "Aceptar" o "Rechazar" seg√∫n corresponda.
            </div>
          </div>
          <!-- FAQ Item 4 -->
          <div style="background: linear-gradient(135deg, #262d48 0%, #37415d 100%); border: 1px solid #2d3342; border-radius: 0.75rem; overflow: hidden;">
            <div style="padding: 1.5rem; cursor: pointer; transition: all 0.3s;" onclick="this.parentElement.classList.toggle('expanded'); this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none';">
              <h3 style="color: #f3f4f6; margin: 0; font-size: 1rem; font-weight: 600;">¬øQu√© significa cada estado de solicitud?</h3>
              <span style="color: #9ca3af; font-size: 0.875rem;">Estados y transiciones</span>
            </div>
            <div style="padding: 0 1.5rem 1.5rem 1.5rem; color: #d1d5db; font-size: 0.95rem; display: none; border-top: 1px solid #2d3342;">
              ‚Ä¢ Pendiente: En espera de revisi√≥n<br>
              ‚Ä¢ Aprobada: Autorizada para ejecuci√≥n<br>
              ‚Ä¢ Rechazada: No cumple requisitos<br>
              ‚Ä¢ Ejecutada: Completada y finalizada
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL: Material Detail -->
  <div id="materialDetailModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center;">
    <div style="background: var(--bg-primary); border-radius: 12px; padding: 24px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; border: 1px solid var(--border-default);">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
        <h2 id="materialDetailTitle" style="margin: 0; color: var(--text-primary);">Material Detail</h2>
        <button id="materialDetailClose" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-secondary);">&times;</button>
      </div>
      <p id="materialDetailBody" style="color: var(--text-secondary); line-height: 1.6;"></p>
    </div>
  </div>

  <!-- SCRIPTS -->
  <script src="/utils/api.js"></script>
  <script src="/app.js"></script>
  <script type="module">
    import { ensureAuth } from './components/auth/auth_guard.js';
    await ensureAuth();
    
    // Cargar datos del usuario
    async function setupUserMenu() {
      try {
        const userResponse = await window.AuthAPI.me();
        const user = userResponse;
        
        // Mostrar nombre del usuario
        const userName = document.getElementById('userName');
        const userNameSidebar = document.getElementById('userNameSidebar');
        const userAvatarSmall = document.getElementById('userAvatarSmall');
        const userRoleSidebar = document.getElementById('userRoleSidebar');
        
        if (userName && user.nombre) {
          userName.textContent = user.nombre;
        }
        if (userNameSidebar && user.nombre) {
          userNameSidebar.textContent = user.nombre;
        }
        if (userAvatarSmall && user.nombre) {
          userAvatarSmall.textContent = user.nombre.charAt(0).toUpperCase();
        }
        if (userRoleSidebar && user.rol) {
          userRoleSidebar.textContent = user.rol;
        }
        
        // Mostrar secci√≥n admin si es administrador
        const adminSection = document.getElementById('adminSection');
        if (adminSection && user.rol === 'Administrador') {
          adminSection.classList.remove('hidden');
        }
        
        // Mostrar secci√≥n planificaci√≥n si es Planificador o Administrador
        const plannerSection = document.getElementById('plannerSection');
        if (plannerSection) {
          const rol = (user.rol || '').toLowerCase();
          if (rol.includes('planificador') || rol.includes('administrador') || rol === 'admin') {
            plannerSection.classList.remove('hidden');
          }
        }
        
        console.log('Usuario cargado:', user);
      } catch (e) {
        console.error('Error cargando datos del usuario:', e);
      }
    }
    
    await setupUserMenu();

    // Logout
    document.getElementById('logoutBtn')?.addEventListener('click', async () => {
      try {
        await window.AuthAPI.logout();
        location.href = '/';
      } catch (e) {
        console.error('Error logging out:', e);
        location.href = '/';
      }
    });

    // ============ COOKIE CONSENT ============
    (function initCookieConsent() {
      const CONSENT_KEY = 'spm_cookies_consent';

      if (localStorage.getItem(CONSENT_KEY) === 'accepted') {
        return;
      }

      const banner = document.createElement('div');
      banner.id = 'cookieConsentBanner';
      banner.innerHTML = `
        <style>
          #cookieConsentBanner {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(10, 14, 39, 0.95);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(124, 58, 237, 0.15);
            padding: 20px;
            color: white;
            font-size: 14px;
            z-index: 9999;
            animation: slideUpBanner 0.4s ease-out;
          }

          @keyframes slideUpBanner {
            from {
              transform: translateY(100%);
              opacity: 0;
            }
            to {
              transform: translateY(0);
              opacity: 1;
            }
          }

          #cookieConsentBanner.hide-banner {
            animation: slideDownBanner 0.4s ease-in;
          }

          @keyframes slideDownBanner {
            from {
              transform: translateY(0);
              opacity: 1;
            }
            to {
              transform: translateY(100%);
              opacity: 0;
            }
          }

          @keyframes spin {
            from {
              transform: rotate(0deg);
            }
            to {
              transform: rotate(360deg);
            }
          }

          @keyframes slideUp {
            from {
              transform: translateY(20px);
              opacity: 0;
            }
            to {
              transform: translateY(0);
              opacity: 1;
            }
          }

          @keyframes slideDown {
            from {
              transform: translateY(0);
              opacity: 1;
            }
            to {
              transform: translateY(20px);
              opacity: 0;
            }
          }

          .cookie-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 20px;
            flex-wrap: wrap;
          }

          .cookie-text {
            flex: 1;
            min-width: 250px;
          }

          .cookie-text a {
            color: #818cf8;
            text-decoration: none;
          }

          .cookie-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            justify-content: flex-end;
          }

          .cookie-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
          }

          .cookie-btn-accept {
            background: linear-gradient(135deg, #6366f1 0%, #ec4899 100%);
            color: white;
          }

          .cookie-btn-accept:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(124, 58, 237, 0.25);
          }

          .cookie-btn-info {
            background: rgba(124, 58, 237, 0.08);
            color: white;
            border: 1px solid rgba(124, 58, 237, 0.25);
          }

          .cookie-btn-info:hover {
            background: rgba(124, 58, 237, 0.15);
          }

          @media (max-width: 640px) {
            .cookie-content {
              flex-direction: column;
              gap: 16px;
            }

            .cookie-actions {
              width: 100%;
            }

            .cookie-btn {
              flex: 1;
            }
          }
        </style>
        <div class="cookie-content">
          <div class="cookie-text">
            <p>üç™ Usamos cookies esenciales para tu seguridad y autenticaci√≥n. <a href="#" onclick="event.preventDefault(); alert('M√°s informaci√≥n.')">M√°s informaci√≥n</a></p>
          </div>
          <div class="cookie-actions">
            <button class="cookie-btn cookie-btn-info" id="rejectCookies" type="button">Rechazar no esenciales</button>
            <button class="cookie-btn cookie-btn-accept" id="acceptCookies" type="button">Aceptar todas</button>
          </div>
        </div>
      `;

      document.body.appendChild(banner);

      const acceptBtn = document.getElementById('acceptCookies');
      const rejectBtn = document.getElementById('rejectCookies');

      acceptBtn?.addEventListener('click', () => {
        localStorage.setItem(CONSENT_KEY, 'accepted');
        banner.classList.add('hide-banner');
        setTimeout(() => banner.remove(), 400);
      });

      rejectBtn?.addEventListener('click', () => {
        localStorage.setItem(CONSENT_KEY, 'accepted');
        banner.classList.add('hide-banner');
        setTimeout(() => banner.remove(), 400);
      });
    })();

    // ============ DASHBOARD DATA & CHARTS ============
    
    // Utility: Format time ago
    function timeAgo(dateString) {
      const date = new Date(dateString);
      const now = new Date();
      const seconds = Math.floor((now - date) / 1000);
      
      if (seconds < 60) return 'Hace unos segundos';
      const minutes = Math.floor(seconds / 60);
      if (minutes < 60) return `Hace ${minutes}m`;
      const hours = Math.floor(minutes / 60);
      if (hours < 24) return `Hace ${hours}h`;
      const days = Math.floor(hours / 24);
      return `Hace ${days}d`;
    }

    // Draw SVG Trend Chart (7-day line chart)
    function drawTrendChart(data) {
      const svg = document.getElementById('trendChart');
      if (!svg || !data || data.length === 0) return;

      svg.innerHTML = '';
      
      const width = svg.clientWidth || 500;
      const height = 200;
      const padding = 40;
      const chartWidth = width - 2 * padding;
      const chartHeight = height - 2 * padding;

      // Find max value for scaling
      const maxValue = Math.max(...data.map(d => d.count), 1);
      
      // Create points
      const points = data.map((d, i) => {
        const x = padding + (i / (data.length - 1)) * chartWidth;
        const y = height - padding - (d.count / maxValue) * chartHeight;
        return { x, y, count: d.count };
      });

      // Draw grid lines
      for (let i = 0; i <= 4; i++) {
        const y = padding + (i / 4) * chartHeight;
        const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line.setAttribute('x1', padding);
        line.setAttribute('y1', y);
        line.setAttribute('x2', width - padding);
        line.setAttribute('y2', y);
        line.setAttribute('stroke', 'rgba(124, 58, 237, 0.08)');
        line.setAttribute('stroke-width', '1');
        svg.appendChild(line);
      }

      // Draw axes
      const xAxis = document.createElementNS('http://www.w3.org/2000/svg', 'line');
      xAxis.setAttribute('x1', padding);
      xAxis.setAttribute('y1', height - padding);
      xAxis.setAttribute('x2', width - padding);
      xAxis.setAttribute('y2', height - padding);
      xAxis.setAttribute('stroke', 'rgba(124, 58, 237, 0.25)');
      xAxis.setAttribute('stroke-width', '2');
      svg.appendChild(xAxis);

      const yAxis = document.createElementNS('http://www.w3.org/2000/svg', 'line');
      yAxis.setAttribute('x1', padding);
      yAxis.setAttribute('y1', padding);
      yAxis.setAttribute('x2', padding);
      yAxis.setAttribute('y2', height - padding);
      yAxis.setAttribute('stroke', 'rgba(124, 58, 237, 0.25)');
      yAxis.setAttribute('stroke-width', '2');
      svg.appendChild(yAxis);

      // Draw line connecting points
      if (points.length > 1) {
        const pathData = points.map((p, i) => `${i === 0 ? 'M' : 'L'} ${p.x} ${p.y}`).join(' ');
        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        path.setAttribute('d', pathData);
        path.setAttribute('stroke', 'url(#trendGradient)');
        path.setAttribute('stroke-width', '3');
        path.setAttribute('fill', 'none');
        svg.appendChild(path);

        // Add gradient
        const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
        const gradient = document.createElementNS('http://www.w3.org/2000/svg', 'linearGradient');
        gradient.setAttribute('id', 'trendGradient');
        gradient.setAttribute('x1', '0%');
        gradient.setAttribute('y1', '0%');
        gradient.setAttribute('x2', '100%');
        gradient.setAttribute('y2', '0%');
        
        const stop1 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
        stop1.setAttribute('offset', '0%');
        stop1.setAttribute('stop-color', '#6366f1');
        gradient.appendChild(stop1);
        
        const stop2 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
        stop2.setAttribute('offset', '100%');
        stop2.setAttribute('stop-color', '#ec4899');
        gradient.appendChild(stop2);
        
        defs.appendChild(gradient);
        svg.appendChild(defs);
      }

      // Draw points and labels
      points.forEach((p, i) => {
        const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        circle.setAttribute('cx', p.x);
        circle.setAttribute('cy', p.y);
        circle.setAttribute('r', '5');
        circle.setAttribute('fill', '#ec4899');
        circle.setAttribute('stroke', 'white');
        circle.setAttribute('stroke-width', '2');
        svg.appendChild(circle);

        // X-axis label
        if (i === 0 || i === points.length - 1 || i % 2 === 0) {
          const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
          text.setAttribute('x', p.x);
          text.setAttribute('y', height - padding + 25);
          text.setAttribute('text-anchor', 'middle');
          text.setAttribute('fill', 'rgba(255, 255, 255, 0.6)');
          text.setAttribute('font-size', '12px');
          text.textContent = data[i].date.substring(5);
          svg.appendChild(text);
        }
      });
    }

    // Draw SVG States Chart (Pie chart)
    function drawStatesChart(states) {
      const svg = document.getElementById('statesChart');
      if (!svg || !states || states.length === 0) return;

      svg.innerHTML = '';
      
      const width = svg.clientWidth || 500;
      const height = 200;
      const centerX = width / 2;
      const centerY = height / 2;
      const radius = Math.min(width, height) / 2 - 40;

      // Colors for pie chart
      const colors = ['#6366f1', '#ec4899', '#10b981', '#f59e0b', '#ef4444'];
      
      // Calculate total
      const total = states.reduce((sum, s) => sum + s.count, 0);
      
      let currentAngle = -Math.PI / 2;
      states.forEach((state, i) => {
        const sliceAngle = (state.count / total) * 2 * Math.PI;
        const startAngle = currentAngle;
        const endAngle = currentAngle + sliceAngle;

        // Calculate arc path
        const x1 = centerX + radius * Math.cos(startAngle);
        const y1 = centerY + radius * Math.sin(startAngle);
        const x2 = centerX + radius * Math.cos(endAngle);
        const y2 = centerY + radius * Math.sin(endAngle);

        const largeArc = sliceAngle > Math.PI ? 1 : 0;

        const pathData = `M ${centerX} ${centerY} L ${x1} ${y1} A ${radius} ${radius} 0 ${largeArc} 1 ${x2} ${y2} Z`;
        
        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        path.setAttribute('d', pathData);
        path.setAttribute('fill', colors[i % colors.length]);
        path.setAttribute('opacity', '0.9');
        path.setAttribute('stroke', 'rgba(255, 255, 255, 0.2)');
        path.setAttribute('stroke-width', '1');
        svg.appendChild(path);

        // Label
        const labelAngle = startAngle + sliceAngle / 2;
        const labelRadius = radius * 0.6;
        const labelX = centerX + labelRadius * Math.cos(labelAngle);
        const labelY = centerY + labelRadius * Math.sin(labelAngle);

        const percentage = Math.round((state.count / total) * 100);
        const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        text.setAttribute('x', labelX);
        text.setAttribute('y', labelY);
        text.setAttribute('text-anchor', 'middle');
        text.setAttribute('dominant-baseline', 'central');
        text.setAttribute('fill', 'white');
        text.setAttribute('font-size', '12px');
        text.setAttribute('font-weight', 'bold');
        text.setAttribute('pointer-events', 'none');
        text.textContent = percentage > 5 ? `${percentage}%` : '';
        svg.appendChild(text);

        currentAngle = endAngle;
      });

      // Legend
      let legendY = 20;
      states.forEach((state, i) => {
        const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
        
        const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
        rect.setAttribute('x', width - 150);
        rect.setAttribute('y', legendY);
        rect.setAttribute('width', '10');
        rect.setAttribute('height', '10');
        rect.setAttribute('fill', colors[i % colors.length]);
        rect.setAttribute('rx', '2');
        g.appendChild(rect);

        const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        text.setAttribute('x', width - 135);
        text.setAttribute('y', legendY + 8);
        text.setAttribute('font-size', '11px');
        text.setAttribute('fill', 'rgba(255, 255, 255, 0.7)');
        text.textContent = `${state.name} (${state.count})`;
        g.appendChild(text);

        svg.appendChild(g);
        legendY += 18;
      });
    }

    // ============ NAVIGATION SYSTEM ============
    const currentPage = { page: 'dashboard' };

    // Navigation function
    window.navigateTo = function(pageName) {
      // Hide all pages
      document.querySelectorAll('.page-content').forEach(page => {
        page.classList.remove('active');
      });

      // Remove active state from all nav items
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
      });

      // Show selected page
      const selectedPage = document.getElementById(`page-${pageName}`);
      if (selectedPage) {
        selectedPage.classList.add('active');
        currentPage.page = pageName;

        // Set active nav item
        const activeNavItem = document.querySelector(`.nav-item[data-page="${pageName}"]`);
        if (activeNavItem) {
          activeNavItem.classList.add('active');
        }

        // Scroll to top
        document.querySelector('.content').scrollTop = 0;

        // Load dashboard data if navigating to dashboard
        if (pageName === 'dashboard') {
          loadDashboardData();
        }

        // Set default values when opening new request form
        if (pageName === 'new-request') {
          // Load form catalogs (centros, almacenes, materiales)
          loadFormCatalogs();
          
          // Load and autofill user's sector
          (async () => {
            try {
              const meResponse = await fetch('/api/auth/me', {
                credentials: 'include',
                headers: { 'Accept': 'application/json' }
              });
              const userData = await meResponse.json();
              const userSector = userData.sector || userData.centro || userData.departamento || '';
              if (userSector) {
                const sectorInput = document.getElementById('newReqSector');
                if (sectorInput) {
                  sectorInput.value = userSector;
                }
              }
            } catch (e) {
              console.log('Could not load user sector:', e);
            }
          })();
          
          // Set criticidad to "Normal" by default
          const critSelect = document.getElementById('newReqCriticidad');
          if (critSelect) {
            critSelect.value = 'Normal';
            critSelect.dispatchEvent(new Event('change', { bubbles: true }));
          }

          // Set fecha to +90 days from today
          const today = new Date();
          const futureDate = new Date(today.getTime() + 90 * 24 * 60 * 60 * 1000);
          const dateStr = futureDate.toISOString().split('T')[0]; // YYYY-MM-DD format
          const dateInput = document.getElementById('newReqFecha');
          if (dateInput) {
            dateInput.value = dateStr;
            dateInput.dispatchEvent(new Event('change', { bubbles: true }));
          }
        }

        // Load pending drafts when navigating to requests page
        if (pageName === 'requests') {
          (async () => {
            try {
              const notifResponse = await fetch('/api/notificaciones', {
                credentials: 'include',
                headers: { 'Accept': 'application/json' }
              });
              const notifData = await notifResponse.json();
              const borradores = notifData.borradores || [];
              const draftsAlert = document.getElementById('draftsAlert');
              const draftCount = document.getElementById('draftCount');
              
              if (borradores && borradores.length > 0) {
                draftCount.textContent = borradores.length;
                draftsAlert.style.display = 'block';
              } else {
                draftsAlert.style.display = 'none';
              }
            } catch (e) {
              console.log('Could not load drafts:', e);
            }
          })();
        }

        if (pageName === 'planner') {
          // Initialize planner page
          initPlannerPage();
        }

        console.log(`Navigated to: ${pageName}`);
      }
    };

    // Set up navigation click handlers
    document.querySelectorAll('.nav-item[data-page]').forEach(navItem => {
      navItem.addEventListener('click', (e) => {
        e.preventDefault();
        const page = navItem.dataset.page;
        window.navigateTo(page);
      });
    });

    // ============ DASHBOARD DATA LOADING ============
    // Load dashboard data and populate UI
    async function loadDashboardData() {
      try {
        const response = await fetch('/api/auth/dashboard/stats', {
          method: 'GET',
          credentials: 'include',
          headers: { 'Accept': 'application/json' }
        });

        if (!response.ok) {
          console.warn('Could not load dashboard data:', response.status);
          return;
        }

        const data = await response.json();
        
        // Update stat cards
        document.getElementById('statPending').textContent = data.stats?.pending || '0';
        document.getElementById('statApproved').textContent = data.stats?.approved || '0';
        document.getElementById('statInProcess').textContent = data.stats?.in_process || '0';
        document.getElementById('statMaterials').textContent = data.stats?.total_materials || '0';

        // Update secondary info
        const approvalRate = data.stats?.approval_rate || 0;
        document.getElementById('statApprovedRate').textContent = `‚úÖ ${approvalRate}% tasa`;
        
        const rejected = data.stats?.rejected || 0;
        document.getElementById('statPendingChange').textContent = `‚ö†Ô∏è ${rejected} rechazadas`;

        const inProcessCount = data.stats?.in_process || 0;
        document.getElementById('statInProcessChange').textContent = `‚è≥ ${inProcessCount} en proceso`;

        // Draw charts
        if (data.chart_data?.trend) {
          drawTrendChart(data.chart_data.trend);
        }
        if (data.chart_data?.states) {
          drawStatesChart(data.chart_data.states);
        }

        // Populate activity list
        if (data.activity && data.activity.length > 0) {
          const activityList = document.getElementById('activityList');
          activityList.innerHTML = '';

          data.activity.forEach(item => {
            const div = document.createElement('div');
            div.className = 'activity-item';
            div.innerHTML = `
              <div class="activity-icon">${item.icon || 'üìù'}</div>
              <div class="activity-content">
                <div class="activity-title">${item.title || 'Sin t√≠tulo'}</div>
                <div class="activity-time">${timeAgo(item.date || new Date())}</div>
              </div>
            `;
            activityList.appendChild(div);
          });
        }

      } catch (e) {
        console.error('Error loading dashboard data:', e);
      }
    }

    // Load data on page load
    loadDashboardData();

    // Refresh data every 5 minutes
    setInterval(loadDashboardData, 5 * 60 * 1000);

    // ============ FORM: NUEVA SOLICITUD ============
    let formData = {
      centro: null,
      sector: null,
      almacen: null,
      criticidad: null,
      fecha: null,
      costos: null,
      justificacion: null,
      materiales: []
    };

    // Cargar cat√°logos y centros cuando se abre el formulario
    window.loadFormCatalogs = async function() {
      try {
        // Load user access
        const accessResponse = await fetch('/api/auth/mi-acceso', {
          credentials: 'include',
          headers: { 'Accept': 'application/json' }
        });
        const accessData = await accessResponse.json();
        const centrosPermitidos = accessData.centros_permitidos || [];
        const almacenesPermitidos = accessData.almacenes_permitidos || [];
        
        // Store access info globally
        window.userAccess = {
          centros: centrosPermitidos,
          almacenes: almacenesPermitidos
        };
        
        const response = await fetch('/api/catalogos', {
          credentials: 'include',
          headers: { 'Accept': 'application/json' }
        });
        const apiResponse = await response.json();
        const catalogs = apiResponse.data || apiResponse;
        
        // Llenar selectores de centros y almacenes
        const centroSelect = document.getElementById('newReqCentro');
        const almacenSelect = document.getElementById('newReqAlmacen');
        
        if (catalogs.centros && centroSelect) {
          centroSelect.innerHTML = '<option value="">Seleccione un Centro</option>';
          catalogs.centros.forEach(c => {
            const hasAccess = centrosPermitidos.includes(c.id);
            const opt = document.createElement('option');
            opt.value = JSON.stringify({ id: c.id, nombre: c.nombre, sector: c.sector, hasAccess });
            
            // Show indicator if no access
            const indicator = hasAccess ? '‚úÖ' : 'ÔøΩ';
            opt.textContent = `${indicator} ${c.id} - ${c.nombre}`;
            
            centroSelect.appendChild(opt);
          });
        }
        
        // Remove old listener and add new one
        const newCentroSelect = centroSelect.cloneNode(true);
        centroSelect.parentNode.replaceChild(newCentroSelect, centroSelect);
        
        newCentroSelect?.addEventListener('change', (e) => {
          if (e.target.value) {
            const centro = JSON.parse(e.target.value);
            document.getElementById('newReqSector').value = centro.sector || '';
            formData.centro = centro;
          }
        });

        if (catalogs.almacenes && almacenSelect) {
          almacenSelect.innerHTML = '<option value="">Seleccione un Almac√©n</option>';
          catalogs.almacenes.forEach(a => {
            const hasAccess = almacenesPermitidos.includes(a.id);
            const opt = document.createElement('option');
            opt.value = JSON.stringify({ id: a.id, nombre: a.nombre, hasAccess });
            
            // Show indicator if no access
            const indicator = hasAccess ? '‚úÖ' : 'ÔøΩ';
            opt.textContent = `${indicator} ${a.id} - ${a.nombre}`;
            
            almacenSelect.appendChild(opt);
          });
        }

        // Cargar materiales
        const materialSelect = document.getElementById('materialSelect');
        if (catalogs.materiales && materialSelect) {
          materialSelect.innerHTML = '<option value="">Seleccione un Material</option>';
          catalogs.materiales.forEach(m => {
            const opt = document.createElement('option');
            opt.value = JSON.stringify({ 
              id: m.id, 
              nombre: m.nombre, 
              precio: m.precio || 0,
              sap: m.sap || m.codigo || '',
              descripcion: m.descripcion || ''
            });
            opt.textContent = m.nombre;
            materialSelect.appendChild(opt);
          });
        }
      } catch (e) {
        console.error('Error cargando cat√°logos:', e);
      }
    };

    // Navegar entre pasos del formulario
    // ===== AUTO-FILL SECTOR =====
    window.autoFillSector = function() {
      const centroSelect = document.getElementById('newReqCentro');
      const sectorInput = document.getElementById('newReqSector');
      
      if (centroSelect.value) {
        try {
          const centro = JSON.parse(centroSelect.value);
          sectorInput.value = centro.sector || '';
        } catch (e) {
          sectorInput.value = '';
        }
      } else {
        sectorInput.value = '';
      }
    };

    // ===== UPDATE JUSTIFICATION COUNTER =====
    window.updateJustCounter = function() {
      const textarea = document.getElementById('newReqJustificacion');
      const counter = document.getElementById('justCounter');
      counter.textContent = textarea.value.length;
    };

    // ===== RESET FORM =====
    window.resetForm = function() {
      if (confirm('¬øLimpiar todos los campos del formulario?')) {
        document.getElementById('newReqCentro').value = '';
        document.getElementById('newReqSector').value = '';
        document.getElementById('newReqAlmacen').value = '';
        
        // Set criticidad default to "Normal"
        document.getElementById('newReqCriticidad').value = 'Normal';
        
        // Set fecha default to +90 days
        const today = new Date();
        const futureDate = new Date(today.getTime() + 90 * 24 * 60 * 60 * 1000);
        const dateStr = futureDate.toISOString().split('T')[0];
        document.getElementById('newReqFecha').value = dateStr;
        
        document.getElementById('newReqCostos').value = '';
        document.getElementById('newReqJustificacion').value = '';
        document.getElementById('justCounter').textContent = '0';
        formData.materiales = [];
        updateMaterialsTable();
        showToast('Formulario limpiado', 'info');
      }
    };

    // ===== SAVE DRAFT =====
    window.saveDraft = async function() {
      // Validate step 1
      const centro = document.getElementById('newReqCentro').value;
      const almacen = document.getElementById('newReqAlmacen').value;
      const criticidad = document.getElementById('newReqCriticidad').value;
      const fecha = document.getElementById('newReqFecha').value;
      const costos = document.getElementById('newReqCostos').value;
      const justificacion = document.getElementById('newReqJustificacion').value;

      if (!centro) {
        showToast('‚ùå Debes seleccionar un Centro', 'error');
        return;
      }
      if (!almacen) {
        showToast('‚ùå Debes seleccionar un Almac√©n', 'error');
        return;
      }
      if (!criticidad) {
        showToast('‚ùå Debes seleccionar una Criticidad', 'error');
        return;
      }
      if (!fecha) {
        showToast('‚ùå Debes seleccionar una Fecha', 'error');
        return;
      }
      if (!costos || costos.trim() === '') {
        showToast('‚ùå Debes ingresar Centro de Costos', 'error');
        return;
      }
      if (!justificacion || justificacion.trim() === '') {
        showToast('‚ùå Debes escribir una Justificaci√≥n', 'error');
        return;
      }

      try {
        const draftData = {
          centro: JSON.parse(centro),
          almacen: JSON.parse(almacen),
          criticidad: criticidad,
          fecha: fecha,
          costos: costos,
          justificacion: justificacion,
          materiales: formData.materiales || [],
          estado: 'borrador'
        };

        const response = await fetch('/api/solicitudes/drafts', {
          method: 'POST',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(draftData)
        });

        if (!response.ok) {
          const error = await response.json();
          showToast('‚ùå Error al guardar borrador: ' + (error.message || response.statusText), 'error');
          return;
        }

        const result = await response.json();
        const draftId = result.id || result.solicitud_id;
        
        // Store draft ID locally
        document.getElementById('solicitudId').value = draftId;
        formData.solicitudId = draftId;

        showToast(`‚úÖ Borrador guardado con ID: ${draftId}`, 'success');
        
        // Optional: navigate to mis-solicitudes after a delay
        setTimeout(() => {
          window.navigateTo('requests');
        }, 1500);
      } catch (e) {
        console.error('Error guardando borrador:', e);
        showToast('‚ùå Error al guardar borrador', 'error');
      }
    };

    // ===== UPDATE STEPPER =====
    window.updateStepperUI = function(stepNum) {
      const stepper = document.querySelector('.form-stepper');
      
      document.querySelectorAll('.stepper-step').forEach((step, idx) => {
        step.classList.remove('active');
        if (idx + 1 === stepNum) {
          step.classList.add('active');
          
          // Add glow effect when step becomes active
          if (stepper && !stepper.classList.contains('glowing')) {
            stepper.classList.add('glowing');
            setTimeout(() => stepper.classList.remove('glowing'), 1200);
          }
        }
      });
    };

    // ===== NAVIGATE FORM STEP =====
    window.navigateFormStep = function(stepName) {
      // Save current data
      formData.centro = document.getElementById('newReqCentro').value ? 
        JSON.parse(document.getElementById('newReqCentro').value) : null;
      formData.almacen = document.getElementById('newReqAlmacen').value ? 
        JSON.parse(document.getElementById('newReqAlmacen').value) : null;
      formData.criticidad = document.getElementById('newReqCriticidad').value;
      formData.fecha = document.getElementById('newReqFecha').value;
      formData.costos = document.getElementById('newReqCostos').value;
      formData.justificacion = document.getElementById('newReqJustificacion').value;

      // Hide all steps
      document.querySelectorAll('#page-new-request .form-step').forEach(s => s.style.display = 'none');

      // Show requested step
      const step1 = document.getElementById('form-step-1');
      const step2 = document.getElementById('form-step-2');
      const step3 = document.getElementById('form-step-3');

      if (stepName === 'info') {
        step1.style.display = 'block';
        updateStepperUI(1);
      } else if (stepName === 'materials') {
        // Validate step 1
        if (!formData.centro) {
          showToast('‚ùå Debes seleccionar un Centro', 'error');
          step1.style.display = 'block';
          updateStepperUI(1);
          return;
        }
        if (!formData.almacen) {
          showToast('‚ùå Debes seleccionar un Almac√©n', 'error');
          step1.style.display = 'block';
          updateStepperUI(1);
          return;
        }
        if (!formData.criticidad) {
          showToast('‚ùå Debes seleccionar una Criticidad', 'error');
          step1.style.display = 'block';
          updateStepperUI(1);
          return;
        }
        if (!formData.fecha) {
          showToast('‚ùå Debes seleccionar una Fecha', 'error');
          step1.style.display = 'block';
          updateStepperUI(1);
          return;
        }
        if (!formData.costos || formData.costos.trim() === '') {
          showToast('‚ùå Debes ingresar Centro de Costos', 'error');
          step1.style.display = 'block';
          updateStepperUI(1);
          return;
        }
        if (!formData.justificacion || formData.justificacion.trim() === '') {
          showToast('‚ùå Debes escribir una Justificaci√≥n', 'error');
          step1.style.display = 'block';
          updateStepperUI(1);
          return;
        }

        loadFormCatalogs();
        step2.style.display = 'block';
        updateStepperUI(2);
      } else if (stepName === 'review') {
        // Validate step 2
        if (formData.materiales.length === 0) {
          showToast('‚ùå Debes agregar al menos 1 material', 'error');
          step2.style.display = 'block';
          updateStepperUI(2);
          return;
        }

        // Fill review data
        document.getElementById('reviewCentro').textContent = formData.centro?.nombre || '-';
        document.getElementById('reviewSector').textContent = formData.centro?.sector || '-';
        document.getElementById('reviewAlmacen').textContent = formData.almacen?.nombre || '-';
        
        const critBadge = formData.criticidad === 'Alta' ? 'üî¥ Alta' : 'üü¢ Normal';
        document.getElementById('reviewCriticidad').textContent = critBadge;
        document.getElementById('reviewFecha').textContent = formData.fecha || '-';
        document.getElementById('reviewCostos').textContent = formData.costos || '-';
        document.getElementById('reviewJustificacion').textContent = formData.justificacion || '-';

        // Check access for this center and warehouse
        const centroNoAcceso = formData.centro?.hasAccess === false;
        const almacenNoAcceso = formData.almacen?.hasAccess === false;
        
        // Show access alert if needed
        const accessAlert = document.getElementById('accessAlert');
        const accessAlertContent = document.getElementById('accessAlertContent');
        if (centroNoAcceso || almacenNoAcceso) {
          let alertMsg = '<strong>No tienes acceso aprobado a:</strong><ul style="margin: 8px 0; padding-left: 20px;">';
          if (centroNoAcceso) alertMsg += `<li>Centro: ${formData.centro?.nombre}</li>`;
          if (almacenNoAcceso) alertMsg += `<li>Almac√©n: ${formData.almacen?.nombre}</li>`;
          alertMsg += '</ul>';
          accessAlertContent.innerHTML = alertMsg;
          accessAlert.style.display = 'block';
        } else {
          accessAlert.style.display = 'none';
        }

        // Fill materials
        const reviewBody = document.getElementById('reviewMaterialsBody');
        reviewBody.innerHTML = '';
        let total = 0;
        formData.materiales.forEach(m => {
          const subtotal = m.cantidad * m.precio;
          total += subtotal;
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${m.nombre}</td>
            <td class="text-right">${m.cantidad}</td>
            <td class="text-right">$${m.precio.toFixed(2)}</td>
            <td class="text-right"><strong>$${subtotal.toFixed(2)}</strong></td>
          `;
          reviewBody.appendChild(row);
        });
        document.getElementById('reviewTotal').textContent = '$' + total.toFixed(2);

        step3.style.display = 'block';
        updateStepperUI(3);
      }

      // Scroll to top
      const content = document.querySelector('.content');
      if (content) content.scrollTop = 0;
    };

    // ===== FILTER MATERIALS BY SAP CODE AND DESCRIPTION =====
    window.filterMaterials = function() {
      const searchSAP = document.getElementById('materialSearchSAP').value.toLowerCase().trim();
      const searchDesc = document.getElementById('materialSearchDesc').value.toLowerCase().trim();
      const materialSelect = document.getElementById('materialSelect');
      
      // Get all options except the placeholder
      const options = materialSelect.querySelectorAll('option');
      let visibleCount = 0;
      
      options.forEach((opt, idx) => {
        if (idx === 0) return; // Skip placeholder
        
        try {
          const material = JSON.parse(opt.value);
          const sap = (material.sap || '').toLowerCase();
          const nombre = (material.nombre || '').toLowerCase();
          const descripcion = (material.descripcion || '').toLowerCase();
          
          // Check if matches either SAP or description search
          const matchesSAP = !searchSAP || sap.includes(searchSAP);
          const matchesDesc = !searchDesc || nombre.includes(searchDesc) || descripcion.includes(searchDesc);
          
          if (matchesSAP && matchesDesc) {
            opt.style.display = '';
            visibleCount++;
          } else {
            opt.style.display = 'none';
          }
        } catch (e) {
          opt.style.display = '';
        }
      });
      
      // Show message if no results
      if (visibleCount === 0 && (searchSAP || searchDesc)) {
        showToast('‚ö†Ô∏è No se encontraron materiales con esos criterios', 'info');
      }
    };

    // ===== HANDLE MATERIAL SELECTION =====
    window.onMaterialSelected = function() {
      const materialSelect = document.getElementById('materialSelect');
      const btnViewDesc = document.getElementById('btnViewDescription');
      
      if (materialSelect.value) {
        btnViewDesc.style.display = '';
      } else {
        btnViewDesc.style.display = 'none';
      }
    };

    // ===== SHOW MATERIAL DESCRIPTION =====
    window.showMaterialDescription = function() {
      const materialSelect = document.getElementById('materialSelect');
      
      if (!materialSelect.value) {
        showToast('‚ö†Ô∏è Selecciona un material primero', 'warning');
        return;
      }
      
      try {
        const material = JSON.parse(materialSelect.value);
        const descripcion = material.descripcion || 'Sin descripci√≥n disponible';
        const sap = material.sap || 'N/A';
        const nombre = material.nombre || 'Desconocido';
        
        // Show modal with description
        const modalHTML = `
          <div class="modal-backdrop" onclick="closeDescriptionModal()">
            <div class="modal-content description-modal" onclick="event.stopPropagation()">
              <div class="modal-header">
                <h2>üìñ Descripci√≥n del Material</h2>
                <button class="btn-close" onclick="closeDescriptionModal()">‚úï</button>
              </div>
              <div class="modal-body">
                <div class="desc-field">
                  <label>Material:</label>
                  <p>${nombre}</p>
                </div>
                <div class="desc-field">
                  <label>C√≥digo SAP:</label>
                  <p>${sap}</p>
                </div>
                <div class="desc-field">
                  <label>Descripci√≥n:</label>
                  <p>${descripcion}</p>
                </div>
              </div>
              <div class="modal-footer">
                <button class="btn btn-primary" onclick="closeDescriptionModal()">Cerrar</button>
              </div>
            </div>
          </div>
        `;
        
        // Remove old modal if exists
        const oldModal = document.querySelector('.modal-backdrop');
        if (oldModal) oldModal.remove();
        
        // Append new modal
        document.body.insertAdjacentHTML('beforeend', modalHTML);
      } catch (e) {
        showToast('‚ùå Error al mostrar descripci√≥n', 'error');
      }
    };

    // ===== CLOSE DESCRIPTION MODAL =====
    window.closeDescriptionModal = function() {
      const modal = document.querySelector('.modal-backdrop');
      if (modal) modal.remove();
    };

    // ===== ADD MATERIAL TO LIST =====
    window.addMaterialToList = function() {
      const materialSelect = document.getElementById('materialSelect');
      const quantityInput = document.getElementById('materialQuantity');
      const priceInput = document.getElementById('materialPrice');

      // Validate
      if (!materialSelect.value || !materialSelect.value.trim()) {
        showToast('‚ùå Selecciona un material', 'error');
        materialSelect.focus();
        return;
      }

      const quantity = parseInt(quantityInput.value);
      const price = parseFloat(priceInput.value);

      if (!quantity || quantity <= 0) {
        showToast('‚ùå La cantidad debe ser mayor a 0', 'error');
        quantityInput.focus();
        return;
      }

      if (!price || price < 0) {
        showToast('‚ùå Ingresa un precio v√°lido', 'error');
        priceInput.focus();
        return;
      }

      try {
        const material = JSON.parse(materialSelect.value);
        
        // Check for duplicates
        const exists = formData.materiales.find(m => m.id === material.id);
        if (exists) {
          // Update quantity and price instead of duplicating
          exists.cantidad = quantity;
          exists.precio = price;
          showToast(`‚úèÔ∏è ${material.nombre} actualizado`, 'info');
        } else {
          // Add new material
          formData.materiales.push({
            id: material.id,
            nombre: material.nombre,
            sap: material.sap || '',
            descripcion: material.descripcion || '',
            cantidad: quantity,
            precio: price
          });
          showToast(`‚ú® ${material.nombre} agregado`, 'success');
        }

        // Clear inputs
        materialSelect.value = '';
        quantityInput.value = '';
        priceInput.value = '';
        
        // Reset button visibility
        document.getElementById('btnViewDescription').style.display = 'none';

        // Update UI
        updateMaterialsTable();
      } catch (e) {
        showToast('‚ùå Error al agregar material', 'error');
      }
    };

    // ===== UPDATE MATERIALS TABLE =====
    function updateMaterialsTable() {
      const tbody = document.getElementById('materialsTableBody');
      const noMaterials = document.getElementById('no-materials');
      const totalQtySpan = document.getElementById('totalQty');
      const totalAmountSpan = document.getElementById('totalAmount');
      const materialCount = document.getElementById('materialCount');

      if (formData.materiales.length === 0) {
        tbody.innerHTML = '';
        tbody.appendChild(noMaterials);
        noMaterials.style.display = 'table-row';
        totalQtySpan.textContent = '0';
        totalAmountSpan.textContent = '$0.00';
        materialCount.textContent = '0 items';
        return;
      }

      noMaterials.style.display = 'none';
      tbody.innerHTML = '';

      let totalQty = 0;
      let totalAmount = 0;

      formData.materiales.forEach((m, index) => {
        const subtotal = m.cantidad * m.precio;
        totalQty += m.cantidad;
        totalAmount += subtotal;

        const row = document.createElement('tr');
        row.innerHTML = `
          <td class="col-material">${m.nombre}</td>
          <td class="col-qty">${m.cantidad}</td>
          <td class="col-price">$${m.precio.toFixed(2)}</td>
          <td class="col-subtotal"><strong>$${subtotal.toFixed(2)}</strong></td>
          <td class="col-action">
            <button type="button" class="btn-delete" onclick="removeMaterial(${index})" title="Eliminar">
              ‚ùå
            </button>
          </td>
        `;
        tbody.appendChild(row);
      });

      totalQtySpan.textContent = totalQty;
      totalAmountSpan.textContent = '$' + totalAmount.toFixed(2);
      materialCount.textContent = formData.materiales.length + ' ' + (formData.materiales.length === 1 ? 'item' : 'items');
    }

    // ===== REMOVE MATERIAL =====
    window.removeMaterial = function(index) {
      if (confirm('¬øEliminar este material?')) {
        formData.materiales.splice(index, 1);
        updateMaterialsTable();
        showToast('Material eliminado', 'info');
      }
    };

    // ===== SUBMIT NEW REQUEST =====
    window.submitNewRequest = async function() {
      const btn = event.target;
      btn.disabled = true;
      btn.innerHTML = '‚è≥ Creando...';

      try {
        // Check if user has access to selected center and warehouse
        const userAccess = window.userAccess || { centros: [], almacenes: [] };
        const centroPerm = formData.centro?.hasAccess !== false;
        const almacenPerm = formData.almacen?.hasAccess !== false;
        
        // Determine if needs additional access approval
        let requiereAprobacionAcceso = false;
        if (!centroPerm || !almacenPerm) {
          requiereAprobacionAcceso = true;
        }
        
        const payload = {
          centro: formData.centro?.id,
          sector: formData.centro?.sector,
          almacen_virtual: formData.almacen?.nombre,
          criticidad: formData.criticidad,
          fecha_necesidad: formData.fecha,
          centro_costos: formData.costos,
          justificacion: formData.justificacion,
          data_json: {
            materiales: formData.materiales.map(m => ({
              id: m.id,
              nombre: m.nombre,
              cantidad: m.cantidad,
              precio: m.precio,
              subtotal: m.cantidad * m.precio
            })),
            requiereAprobacionAcceso: requiereAprobacionAcceso,
            centroSinAcceso: !centroPerm,
            almacenSinAcceso: !almacenPerm
          },
          total_monto: formData.materiales.reduce((sum, m) => sum + (m.cantidad * m.precio), 0)
        };

        const response = await fetch('/api/solicitudes', {
          method: 'POST',
          credentials: 'include',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify(payload)
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.message || 'Error al crear solicitud');
        }

        const result = await response.json();
        
        if (requiereAprobacionAcceso) {
          showToast('‚úÖ Solicitud creada. ‚ö†Ô∏è Requiere aprobaci√≥n para acceso a Centro/Almac√©n', 'info');
        } else {
          showToast('‚úÖ ¬°Solicitud creada exitosamente!', 'success');
        }

        // Reset form
        setTimeout(() => {
          formData = {
            centro: null,
            almacen: null,
            criticidad: '',
            fecha: '',
            costos: '',
            justificacion: '',
            materiales: []
          };
          
          // Clear all inputs
          document.getElementById('newReqCentro').value = '';
          document.getElementById('newReqSector').value = '';
          document.getElementById('newReqAlmacen').value = '';
          document.getElementById('newReqCriticidad').value = '';
          document.getElementById('newReqFecha').value = '';
          document.getElementById('newReqCostos').value = '';
          document.getElementById('newReqJustificacion').value = '';
          document.getElementById('justCounter').textContent = '0';
          updateMaterialsTable();
          updateStepperUI(1);

          // Go to Requests page
          window.navigateTo('requests');
          loadDashboardData();
        }, 1500);
      } catch (e) {
        console.error('Error creando solicitud:', e);
        showToast('‚ùå ' + e.message, 'error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = '‚úì Confirmar y Crear Solicitud';
      }
    };

    // ===== ADD CSS FOR DELETE BUTTON =====
    const styleSheet = document.createElement('style');
    styleSheet.textContent = `
      .btn-delete {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 16px;
        padding: 4px 8px;
        border-radius: 4px;
        transition: var(--transition);
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .btn-delete:hover {
        background: rgba(239, 68, 68, 0.2);
      }
    `;
    document.head.appendChild(styleSheet);

    // Toast notification
    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.style.cssText = `
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#6366f1'};
        color: white;
        padding: 14px 20px;
        border-radius: 8px;
        font-size: 14px;
        z-index: 9999;
        animation: slideUp 0.3s ease-out;
      `;
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.style.animation = 'slideDown 0.3s ease-in';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    // Estilo para bot√≥n icono
    const btnIconStyleSheet = document.createElement('style');
    btnIconStyleSheet.textContent = `
      .btn-icon {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 16px;
        padding: 4px 8px;
        border-radius: 4px;
        transition: all 0.2s ease;
      }
      .btn-icon:hover {
        background: rgba(239, 68, 68, 0.2);
      }
    `;
    document.head.appendChild(btnIconStyleSheet);

    // Inicializar formulario cuando se abre la p√°gina
    const originalNavigateTo = window.navigateTo;
    window.navigateTo = function(pageName) {
      originalNavigateTo(pageName);
      if (pageName === 'new-request') {
        // Mostrar primer paso
        document.getElementById('form-step-1').style.display = 'block';
        document.getElementById('form-step-2').style.display = 'none';
        document.getElementById('form-step-3').style.display = 'none';
        
        // Setup filled state detection for inputs
        setupInputFilledState();
      }
    };
    
    
    // Setup filled state for form inputs
    function setupInputFilledState() {
      const allInputs = document.querySelectorAll('input, select, textarea');
      
      allInputs.forEach(input => {
        const updateFilledState = () => {
          const hasValue = input.value && input.value.trim() !== '';
          if (hasValue) {
            input.setAttribute('data-filled', 'true');
          } else {
            input.removeAttribute('data-filled');
          }
        };
        
        // Check initial state
        updateFilledState();
        
        // Listen for changes
        input.addEventListener('input', updateFilledState);
        input.addEventListener('change', updateFilledState);
        
        // Also check on blur
        input.addEventListener('blur', updateFilledState);
        
        // Handle programmatic value changes
        input.addEventListener('load', updateFilledState);
      });
    }

    // ===== AI ASSISTANT WIDGET FUNCTIONS =====
    window.toggleAIPanel = function() {
      const panel = document.getElementById('aiPanel');
      panel.classList.toggle('active');
    };

    window.askAI = function(question) {
      const input = document.getElementById('aiInput');
      input.value = question;
      sendAIMessage();
    };

    window.sendAIMessage = async function() {
      const input = document.getElementById('aiInput');
      const content = document.getElementById('aiPanelContent');
      const message = input.value.trim();

      if (!message) return;

      // Add user message
      const userMsg = document.createElement('div');
      userMsg.className = 'ai-message user';
      userMsg.textContent = message;
      content.appendChild(userMsg);
      input.value = '';

      // Clear initial suggestions if present
      const suggestionsDiv = document.getElementById('aiInitialSuggestions');
      if (suggestionsDiv) {
        suggestionsDiv.style.display = 'none';
      }

      // Add loading indicator
      const loadingMsg = document.createElement('div');
      loadingMsg.className = 'ai-message loading';
      loadingMsg.innerHTML = '<span>ü§ñ Analizando</span> <div class="ai-loading-dots"><span></span><span></span><span></span></div>';
      content.appendChild(loadingMsg);

      // Get current material context
      let materialCodigo = null;
      try {
        const materialSelect = document.getElementById('materialSelect');
        if (materialSelect && materialSelect.value) {
          try {
            const parsedMaterial = JSON.parse(materialSelect.value);
            materialCodigo = parsedMaterial.codigo;
          } catch (e) {
            // Si no es JSON, usar directamente el valor
            materialCodigo = materialSelect.value;
          }
        }
      } catch (e) {
        console.log('No hay material seleccionado');
      }

      const centro = document.getElementById('centroSelect')?.value || null;

      // Extract user_id from JWT if available
      let userId = 'anonymous';
      try {
        const token = localStorage.getItem('auth_token') || sessionStorage.getItem('auth_token');
        if (token) {
          const payload = JSON.parse(atob(token.split('.')[1]));
          userId = payload.sub || payload.user_id || 'anonymous';
        }
      } catch (e) {
        console.log('No se pudo extraer user_id del JWT');
      }

      try {
        // Preparar payload con user_id y context completo
        const payload = {
          message: message,
          material_codigo: materialCodigo || "",
          centro: centro || "",
          context: typeof formData !== 'undefined' ? formData : {}
        };

        console.log('üì§ Enviando mensaje IA v2:', { user_id: userId, ...payload });

        // Llamar a endpoint v2 con JWT si est√° disponible
        const headers = { 'Content-Type': 'application/json' };
        const token = localStorage.getItem('auth_token') || sessionStorage.getItem('auth_token');
        if (token) {
          headers['Authorization'] = `Bearer ${token}`;
        }

        // AI Assistant desactivado - endpoint comentado
        // const response = await fetch('/api/form-intelligence/chat', {
        //   method: 'POST',
        //   headers: headers,
        //   body: JSON.stringify(payload)
        // });
        const response = { ok: false, status: 503 };
        if (response && !response.ok) {
          const error = new Error('AI Assistant no disponible');
          throw error;
        }

        console.log('üì• Response status:', response.status);

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || `HTTP ${response.status}`);
        }

        const data = await response.json();
        console.log('‚úÖ Respuesta IA v2:', data);

        // Remove loading indicator
        loadingMsg.remove();

        // Add AI response
        const aiMsg = document.createElement('div');
        aiMsg.className = 'ai-message assistant';
        aiMsg.textContent = data.response || 'No pude procesar tu pregunta. Intenta de otra forma.';
        content.appendChild(aiMsg);

        // Add suggestions if available
        if (data.suggestions && data.suggestions.length > 0) {
          const suggestionsContainer = document.createElement('div');
          suggestionsContainer.className = 'ai-suggestions-response';
          suggestionsContainer.style.cssText = 'margin-top: 8px; display: flex; gap: 6px; flex-wrap: wrap;';
          
          data.suggestions.forEach(suggestion => {
            const chip = document.createElement('div');
            chip.className = 'ai-suggestion-chip';
            chip.style.cssText = 'cursor: pointer; font-size: 11px; padding: 4px 8px; background: #e8f4f8; border-radius: 12px; color: #0066cc; transition: background 0.2s;';
            chip.textContent = suggestion;
            chip.onmouseover = () => chip.style.background = '#0066cc'; 
            chip.onmouseout = () => chip.style.background = '#e8f4f8';
            chip.onclick = () => askAI(suggestion);
            suggestionsContainer.appendChild(chip);
          });
          
          content.appendChild(suggestionsContainer);
        }

      } catch (error) {
        console.error('‚ùå Error IA v2:', error);
        loadingMsg.remove();
        const errorMsg = document.createElement('div');
        errorMsg.className = 'ai-message assistant';
        errorMsg.textContent = '‚ùå Error: ' + error.message;
        content.appendChild(errorMsg);
      }

      // Auto-scroll to bottom
      content.scrollTop = content.scrollHeight;
    };

    // ===== CLEAR AI HISTORY =====
    window.clearAIHistory = async function() {
      if (!confirm('¬øEst√°s seguro de que quieres limpiar el historial de conversaciones?')) return;
      
      // Extract user_id from JWT
      let userId = 'anonymous';
      try {
        const token = localStorage.getItem('auth_token') || sessionStorage.getItem('auth_token');
        if (token) {
          const payload = JSON.parse(atob(token.split('.')[1]));
          userId = payload.sub || payload.user_id || 'anonymous';
        }
      } catch (e) {
        console.log('No se pudo extraer user_id del JWT');
      }

      try {
        const headers = { 'Content-Type': 'application/json' };
        const token = localStorage.getItem('auth_token') || sessionStorage.getItem('auth_token');
        if (token) {
          headers['Authorization'] = `Bearer ${token}`;
        }

        // AI Assistant desactivado - endpoint comentado
        // const response = await fetch(`/api/form-intelligence/history/${userId}`, {
        //   method: 'DELETE',
        //   headers: headers
        // });
        console.log('AI Assistant no disponible - historial no puede limpiarse');
        return;
      } catch (error) {
        console.error('‚ùå Error limpiando historial:', error);
        alert('Error: ' + error.message);
      }
    };

    // Enter key to send message
    document.addEventListener('DOMContentLoaded', function() {
      const aiInput = document.getElementById('aiInput');
      if (aiInput) {
        aiInput.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            window.sendAIMessage();
          }
        });
      }
    });

    // ===== SUGGESTION HINTS WHILE TYPING ===== (DESACTIVADO: AI Assistant removido)
    window.suggestMaterialOnType = async function() {
      // AI Assistant no disponible
      console.log('AI Assistant no disponible - sugerencias desactivadas');
      return;
      /* C√≥digo original comentado:
      const materialSelect = document.getElementById('materialSelect');
      const searchInput = document.getElementById('materialSearchSAP') || document.getElementById('materialSearchDesc');
      
      if (!searchInput || !searchInput.value.trim()) return;

      try {
        const response = await fetch('/api/form-intelligence/suggest', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            field_type: 'material_search',
            query: searchInput.value.trim(),
            centro: document.getElementById('centroSelect')?.value,
            limit: 5
          })
        });

        if (response.ok) {
          const data = await response.json();
          // Aqu√≠ podr√≠as actualizar auto-completes visuales
          // Por ahora, el filtrado se hace en tiempo real con filterMaterials()
        }
      } catch (error) {
        console.log('Sugerencia IA no disponible');
      }
      */
    };

    // ===== SMART QUANTITY VALIDATION ===== (DESACTIVADO: AI Assistant removido)
    window.validateQuantityWithAI = async function() {
      // AI Assistant no disponible
      console.log('AI Assistant no disponible - validaci√≥n desactivada');
      return;
      /* C√≥digo original comentado:
      const qtyInput = document.getElementById('cantidadInput');
      const materialSelect = document.getElementById('materialSelect');
      
      if (!qtyInput.value || !materialSelect.value) return;

      try {
        const material = JSON.parse(materialSelect.value);
        const response = await fetch('/api/form-intelligence/suggest', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            field_type: 'cantidad',
            material_codigo: material.codigo,
            centro: document.getElementById('centroSelect')?.value
          })
        });

        if (response.ok) {
          const data = await response.json();
          const suggested = data.consumo_promedio_un * 30; // Monthly estimate
          const actual = parseFloat(qtyInput.value);

          if (actual > suggested * 2) {
            showToast(`‚ö†Ô∏è Cantidad muy alta vs hist√≥rico (${suggested.toFixed(0)} UN t√≠picos)`, 'warning');
          } else if (actual < suggested * 0.5) {
            showToast(`‚ÑπÔ∏è Cantidad baja vs hist√≥rico (${suggested.toFixed(0)} UN t√≠picos)`, 'info');
          }
        }
      } catch (error) {
        console.log('Validaci√≥n IA no disponible');
      }
      */
    };
    window.analyzeMaterialIntelligence = async function() {
      // AI Assistant no disponible
      console.log('AI Assistant no disponible - an√°lisis desactivado');
      return;
    };

    // Hook para analizar cuando se selecciona material
    const originalOnMaterialSelected = window.onMaterialSelected;
    if (originalOnMaterialSelected) {
      window.onMaterialSelected = function() {
        originalOnMaterialSelected();
        window.analyzeMaterialIntelligence();
      };
    }

    // Hook para validar cantidad cuando cambia (DESACTIVADO: AI Assistant removido)
    document.addEventListener('DOMContentLoaded', function() {
      const qtyInput = document.getElementById('cantidadInput');
      if (qtyInput) {
        // qtyInput.addEventListener('blur', window.validateQuantityWithAI);  // DESACTIVADO
      }
    });

    // ============ NAVIGATION HANDLER ============
    function initializeNavigation() {
      document.querySelectorAll('.nav-item').forEach(navItem => {
        navItem.addEventListener('click', (e) => {
          e.preventDefault();
          
          const page = navItem.getAttribute('data-page');
          if (!page) return;
          
          // Hide all pages
          document.querySelectorAll('.page-content').forEach(p => {
            p.classList.remove('active');
          });
          
          // Show selected page
          const pageElement = document.getElementById(`page-${page}`);
          if (pageElement) {
            pageElement.classList.add('active');
          }
          
          // Update active nav item
          document.querySelectorAll('.nav-item').forEach(item => {
            item.classList.remove('active');
          });
          navItem.classList.add('active');
          
          // Initialize specific page functionality
          if (page === 'add-materials' && typeof initAddMaterialsPage === 'function') {
            console.log('Initializing Add Materials page...');
            initAddMaterialsPage();
          }
          
          console.log(`Navigated to: ${page}`);
        });
      });
    }
    
    // Initialize navigation when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeNavigation);
    } else {
      initializeNavigation();
    }

    // ============ PLANNER PAGE STATE AND FUNCTIONS ============
    const plannerState = {
      currentPage: 1,
      itemsPerPage: 10,
      solicitudes: [],
      currentSolicitud: null,
      user: null,
      isPlanner: false
    };

    // Planner: Show toast message
    function showPlannerMessage(msg, isSuccess = false) {
      const container = document.getElementById('toasts');
      if (!container) {
        alert(msg);
        return;
      }
      
      const node = document.createElement('div');
      node.className = `toast ${isSuccess ? 'ok' : 'err'}`;
      node.textContent = msg;
      node.style.marginBottom = '8px';
      node.style.padding = '12px 16px';
      node.style.borderRadius = '6px';
      node.style.backgroundColor = isSuccess ? '#10b981' : '#ef4444';
      node.style.color = 'white';
      node.style.fontSize = '14px';
      container.appendChild(node);
      
      setTimeout(() => {
        node.style.opacity = '0';
        node.style.transition = 'opacity 0.3s ease';
        setTimeout(() => node.remove(), 300);
      }, 3000);
    }

    // Planner: Wait for AuthAPI
    async function waitForAuthAPI(maxAttempts = 50) {
      console.log('[planner] Esperando AuthAPI...');
      for (let i = 0; i < maxAttempts; i++) {
        if (window.AuthAPI && typeof window.AuthAPI.me === 'function') {
          console.log('[planner] ‚úì AuthAPI encontrado en intento', i);
          return;
        }
        await new Promise(resolve => setTimeout(resolve, 100));
      }
      throw new Error('AuthAPI no se carg√≥ correctamente');
    }

    // Planner: Check access permissions
    async function checkPlannerAccess() {
      try {
        await waitForAuthAPI();
        const user = await window.AuthAPI.me();
        plannerState.user = user;
        
        console.log('[planner] Usuario:', user.username, 'Rol:', user.rol);
        
        // Verificar si es Planificador o Administrador
        const rolesPermitidos = ['Planificador', 'Administrador', 'admin', 'planificador'];
        const tieneAcceso = rolesPermitidos.some(rol => 
          (user.rol || '').toLowerCase().includes(rol.toLowerCase())
        );
        
        if (!tieneAcceso) {
          console.error('[planner] Acceso denegado: rol insuficiente', user.rol);
          showPlannerMessage('No tienes permiso para acceder a esta secci√≥n', false);
          return false;
        }
        
        plannerState.isPlanner = true;
        console.log('[planner] ‚úì Acceso permitido');
        return true;
      } catch (err) {
        console.error('[planner] Error verificando acceso:', err);
        return false;
      }
    }

    // Planner: Load solicitudes from API
    async function loadPlannerSolicitudes() {
      try {
        console.log('[planner] Cargando solicitudes...');
        
        const response = await fetch('/api/planner/solicitudes?page=' + plannerState.currentPage + '&per_page=' + plannerState.itemsPerPage, {
          credentials: 'include',
          headers: { 'Accept': 'application/json' }
        });
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        plannerState.solicitudes = data.solicitudes || data.data || [];
        
        console.log('[planner] ‚úì Solicitudes cargadas:', plannerState.solicitudes.length);
        renderPlannerSolicitudes();
        updatePlannerStats();
      } catch (err) {
        console.error('[planner] Error cargando solicitudes:', err);
        showPlannerMessage('Error al cargar solicitudes', false);
      }
    }

    // Planner: Render solicitudes table
    function renderPlannerSolicitudes() {
      const tbody = document.querySelector('#solicitudesTable tbody');
      if (!tbody) return;
      
      if (plannerState.solicitudes.length === 0) {
        tbody.innerHTML = `
          <tr class="empty-row">
            <td colspan="8" style="text-align: center; padding: 32px; color: var(--text-secondary);">
              No hay solicitudes para procesar
            </td>
          </tr>
        `;
        return;
      }
      
      tbody.innerHTML = plannerState.solicitudes.map(sol => `
        <tr data-id="${sol.id}" style="cursor: pointer;">
          <td>${sol.id}</td>
          <td>${sol.centro || '‚Äî'}</td>
          <td>${sol.sector || '‚Äî'}</td>
          <td><span class="badge badge--${(sol.criticidad || 'normal').toLowerCase()}">${sol.criticidad || 'Normal'}</span></td>
          <td>${sol.items_count || 0}</td>
          <td style="text-align: right;">$${(sol.total || 0).toLocaleString('es-AR', {minimumFractionDigits: 2})}</td>
          <td><span class="state state--${(sol.estado || 'pending').toLowerCase()}">${sol.estado || 'Pendiente'}</span></td>
          <td>
            <button type="button" class="btn-mini pri" data-action="view" data-id="${sol.id}">Ver</button>
          </td>
        </tr>
      `).join('');
      
      // Add event listeners to view buttons
      tbody.querySelectorAll('[data-action="view"]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const id = e.target.dataset.id;
          showPlannerDetail(id);
        });
      });

      // Add row click listeners
      tbody.querySelectorAll('tr[data-id]').forEach(row => {
        row.addEventListener('click', (e) => {
          if (e.target.closest('[data-action]')) return; // Don't trigger if button was clicked
          const id = row.dataset.id;
          showPlannerDetail(id);
        });
      });
    }

    // Planner: Show detail panel
    async function showPlannerDetail(solicitudId) {
      try {
        console.log('[planner] Mostrando detalles de solicitud:', solicitudId);
        
        const response = await fetch(`/api/planner/solicitudes/${solicitudId}`, {
          credentials: 'include',
          headers: { 'Accept': 'application/json' }
        });
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        plannerState.currentSolicitud = data;
        
        // Fill detail panel
        const detailPanel = document.getElementById('detailPanel');
        const solicitudIdEl = document.getElementById('detailSolicitudId');
        const detailCentro = document.getElementById('detailCentro');
        const detailSector = document.getElementById('detailSector');
        const detailCriticidad = document.getElementById('detailCriticidad');
        const detailEstado = document.getElementById('detailEstado');
        
        if (solicitudIdEl) solicitudIdEl.textContent = `#${data.id}`;
        if (detailCentro) detailCentro.textContent = data.centro || '‚Äî';
        if (detailSector) detailSector.textContent = data.sector || '‚Äî';
        if (detailCriticidad) detailCriticidad.textContent = data.criticidad || '‚Äî';
        if (detailEstado) detailEstado.textContent = data.estado || '‚Äî';
        
        // Fill materials table
        const materialesBody = document.getElementById('detailMateriales');
        if (materialesBody) {
          if (data.materiales && data.materiales.length > 0) {
            materialesBody.innerHTML = data.materiales.map(mat => `
              <tr>
                <td>${mat.nombre || mat.description || '‚Äî'}</td>
                <td>${mat.cantidad || 0}</td>
                <td>${mat.unidad || 'UN'}</td>
                <td>$${(mat.precio_unitario || 0).toFixed(2)}</td>
                <td>$${((mat.cantidad || 0) * (mat.precio_unitario || 0)).toFixed(2)}</td>
              </tr>
            `).join('');
          } else {
            materialesBody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 16px;">Sin materiales</td></tr>';
          }
        }
        
        // Show optimization analysis
        showPlannerOptimizationAnalysis(data);
        
        // Display panel
        if (detailPanel) {
          detailPanel.style.display = 'block';
          detailPanel.removeAttribute('hidden');
        }
        window.scrollTo({ top: 0, behavior: 'smooth' });
      } catch (err) {
        console.error('[planner] Error cargando detalles:', err);
        showPlannerMessage('Error al cargar detalles de solicitud', false);
      }
    }

    // Planner: Show optimization analysis
    function showPlannerOptimizationAnalysis(solicitud) {
      const resultsDiv = document.getElementById('optimizationResults');
      if (!resultsDiv) return;
      
      const analysis = {
        consolidationOpportunity: '3 proveedores pueden abastecer el 85% del pedido',
        costOptimization: 'Potencial de ahorro: 12% ($' + ((solicitud.total || 0) * 0.12).toFixed(2) + ')',
        leadTimeRisk: 'Criticidad Alta - Plazo: 5 d√≠as',
        alternativeItems: '2 √≠tems equivalentes disponibles con mejor precio'
      };
      
      resultsDiv.innerHTML = `
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
          <div style="padding: 12px; background: var(--bg-primary); border-left: 3px solid #3b82f6; border-radius: 4px;">
            <strong>üîó Consolidaci√≥n</strong>
            <p style="margin: 4px 0 0 0; font-size: 12px;">${analysis.consolidationOpportunity}</p>
          </div>
          <div style="padding: 12px; background: var(--bg-primary); border-left: 3px solid #10b981; border-radius: 4px;">
            <strong>üí∞ Ahorro</strong>
            <p style="margin: 4px 0 0 0; font-size: 12px;">${analysis.costOptimization}</p>
          </div>
          <div style="padding: 12px; background: var(--bg-primary); border-left: 3px solid #f59e0b; border-radius: 4px;">
            <strong>‚è±Ô∏è Riesgo</strong>
            <p style="margin: 4px 0 0 0; font-size: 12px;">${analysis.leadTimeRisk}</p>
          </div>
          <div style="padding: 12px; background: var(--bg-primary); border-left: 3px solid #8b5cf6; border-radius: 4px;">
            <strong>üîÑ Equivalentes</strong>
            <p style="margin: 4px 0 0 0; font-size: 12px;">${analysis.alternativeItems}</p>
          </div>
        </div>
      `;
    }

    // Planner: Update statistics
    async function updatePlannerStats() {
      try {
        const response = await fetch('/api/planner/dashboard', {
          credentials: 'include',
          headers: { 'Accept': 'application/json' }
        });
        
        if (!response.ok) {
          console.warn('[planner] Could not load stats:', response.status);
          return;
        }
        
        const stats = await response.json();
        
        const statPending = document.getElementById('statPending');
        const statInProcess = document.getElementById('statInProcess');
        const statOptimized = document.getElementById('statOptimized');
        const statCompleted = document.getElementById('statCompleted');
        
        if (statPending) statPending.textContent = stats.pending || 0;
        if (statInProcess) statInProcess.textContent = stats.in_process || 0;
        if (statOptimized) statOptimized.textContent = stats.optimized || 0;
        if (statCompleted) statCompleted.textContent = stats.completed || 0;
      } catch (err) {
        console.error('[planner] Error loading stats:', err);
      }
    }

    // Planner: Initialize page
    async function initPlannerPage() {
      console.log('[planner] Inicializando p√°gina...');
      
      try {
        // Check access
        const hasAccess = await checkPlannerAccess();
        if (!hasAccess) {
          showPlannerMessage('Acceso denegado', false);
          return;
        }
        
        // Load solicitudes and stats
        await loadPlannerSolicitudes();
        
        // Setup event listeners
        const btnRefresh = document.getElementById('btnRefresh');
        if (btnRefresh) {
          btnRefresh.addEventListener('click', () => {
            plannerState.currentPage = 1;
            loadPlannerSolicitudes();
          });
        }
        
        const btnCloseDetail = document.getElementById('btnCloseDetail');
        if (btnCloseDetail) {
          btnCloseDetail.addEventListener('click', () => {
            const detailPanel = document.getElementById('detailPanel');
            if (detailPanel) {
              detailPanel.style.display = 'none';
              detailPanel.setAttribute('hidden', '');
            }
            plannerState.currentSolicitud = null;
          });
        }

        const btnOptimize = document.getElementById('btnOptimize');
        if (btnOptimize && !btnOptimize.hasListener) {
          btnOptimize.hasListener = true;
          btnOptimize.addEventListener('click', async () => {
            if (!plannerState.currentSolicitud) return;
            
            try {
              const response = await fetch(`/api/planner/solicitudes/${plannerState.currentSolicitud.id}/optimize`, {
                method: 'POST',
                credentials: 'include',
                headers: { 'Accept': 'application/json', 'Content-Type': 'application/json' }
              });
              
              if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
              }
              
              const result = await response.json();
              showPlannerMessage('Optimizaci√≥n completada', true);
              await loadPlannerSolicitudes();
            } catch (err) {
              console.error('[planner] Error optimizing:', err);
              showPlannerMessage('Error al optimizar solicitud', false);
            }
          });
        }

        // Pagination
        const btnPrevPage = document.getElementById('btnPrevPage');
        if (btnPrevPage && !btnPrevPage.hasListener) {
          btnPrevPage.hasListener = true;
          btnPrevPage.addEventListener('click', () => {
            if (plannerState.currentPage > 1) {
              plannerState.currentPage--;
              loadPlannerSolicitudes();
            }
          });
        }

        const btnNextPage = document.getElementById('btnNextPage');
        if (btnNextPage && !btnNextPage.hasListener) {
          btnNextPage.hasListener = true;
          btnNextPage.addEventListener('click', () => {
            plannerState.currentPage++;
            loadPlannerSolicitudes();
          });
        }
        
        console.log('[planner] ‚úì P√°gina inicializada correctamente');
      } catch (err) {
        console.error('[planner] Error inicializando p√°gina:', err);
        showPlannerMessage('Error cargando la p√°gina', false);
      }
    }
  </script>
</body>
</html>





