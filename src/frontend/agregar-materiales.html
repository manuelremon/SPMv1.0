<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Agregar Materiales - SPM</title>
  <link rel="stylesheet" href="/styles.css">
  <style>
    .materials-container {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: var(--spacing-lg);
    }

    .materials-search {
      background: var(--surface-primary);
      border-radius: var(--radius-lg);
      padding: var(--spacing-lg);
      box-shadow: var(--shadow-sm);
    }

    .search-box {
      display: flex;
      gap: var(--spacing-md);
      margin-bottom: var(--spacing-lg);
    }

    .search-input {
      flex: 1;
      padding: var(--spacing-sm) var(--spacing-md);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
    }

    .materials-list {
      display: grid;
      gap: var(--spacing-md);
    }

    .material-card {
      border: 1px solid var(--border-color);
      padding: var(--spacing-md);
      border-radius: var(--radius-md);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .material-info h3 {
      margin: 0 0 var(--spacing-xs) 0;
      font-size: 1rem;
    }

    .material-meta {
      font-size: 0.875rem;
      color: var(--text-secondary);
    }

    .request-summary {
      background: var(--surface-primary);
      border-radius: var(--radius-lg);
      padding: var(--spacing-lg);
      box-shadow: var(--shadow-sm);
      height: fit-content;
    }

    .summary-items {
      margin: var(--spacing-lg) 0;
      max-height: 400px;
      overflow-y: auto;
    }

    .summary-item {
      display: flex;
      justify-content: space-between;
      padding: var(--spacing-sm) 0;
      border-bottom: 1px solid var(--border-color);
    }

    .summary-total {
      border-top: 2px solid var(--border-color);
      padding-top: var(--spacing-md);
      font-weight: bold;
      display: flex;
      justify-content: space-between;
      font-size: 1.1rem;
    }

    .actions-bar {
      margin-top: var(--spacing-xl);
      display: flex;
      justify-content: flex-end;
      gap: var(--spacing-md);
    }
  </style>
</head>
<body>
  <header class="app-header">
    <a href="/dashboard">Dashboard</a>
    <nav>
      <a href="/mi-cuenta">Mi Cuenta</a>
      <a href="/mis-solicitudes">Mis Solicitudes</a>
      <a href="/crear-solicitud">Crear Solicitud</a>
      <a href="/materiales">Materiales</a>
      <a href="/admin">Admin</a>
    </nav>
  </header>

  <main class="main-container">
    <div class="content-header">
      <h1 class="page-title">Agregar Materiales</h1>
      <p class="page-subtitle">Solicitud #<span id="solicitudId">-</span></p>
    </div>

    <div class="materials-container">
      <!-- Search & List -->
      <div class="materials-search">
        <div class="search-box">
          <input type="text" id="searchInput" class="search-input" placeholder="Buscar material por código o descripción...">
          <button class="btn btn-secondary" id="searchBtn">Buscar</button>
        </div>

        <div id="materialsList" class="materials-list">
          <!-- Material cards will be inserted here -->
          <div class="loading">Cargando materiales...</div>
        </div>
      </div>

      <!-- Request Summary -->
      <div class="request-summary">
        <h3>Resumen de Solicitud</h3>
        <div class="summary-items" id="selectedItems">
          <!-- Selected items will be listed here -->
        </div>
        <div class="summary-total">
          <span>Total Estimado</span>
          <span id="totalAmount">$0.00</span>
        </div>

        <div class="actions-bar">
          <button class="btn btn-secondary" onclick="window.location.href='/solicitudes.html'">Guardar y Salir</button>
          <button class="btn btn-primary" id="finalizeBtn">Finalizar Solicitud</button>
        </div>
      </div>
    </div>
  </main>

  <script src="/boot.js"></script>
  <script src="/utils/api.js"></script>
  <script>
const urlParams = new URLSearchParams(window.location.search);
const solicitudId = urlParams.get('id');
let currentSolicitud = { items: [] };
let allMaterials = [];

if (!solicitudId) {
  alert('No se especificó una solicitud');
  window.location.href = '/crear-solicitud';
}

async function init() {
  try {
    const token = localStorage.getItem('token');
    const solRes = await fetch(`/api/solicitudes/${solicitudId}`, {
      headers: {
        'Accept': 'application/json',
        ...(token ? { 'Authorization': `Bearer ${token}` } : {})
      },
      credentials: 'include'
    });
    if (!solRes.ok) throw new Error('Error cargando solicitud');
    const solData = await solRes.json();
    currentSolicitud = solData.solicitud || solData;
    if (!Array.isArray(currentSolicitud.items)) {
      currentSolicitud.items = [];
    }

    const matRes = await fetch('/api/materiales', {
      headers: {
        'Accept': 'application/json',
        ...(token ? { 'Authorization': `Bearer ${token}` } : {})
      },
      credentials: 'include'
    });
    const matData = await matRes.json();
    allMaterials = Array.isArray(matData) ? matData : (matData.items || []);

    renderSummary();
    renderMaterials(allMaterials);
  } catch (err) {
    console.error(err);
    alert('Error inicializando página: ' + err.message);
  }
}

function renderMaterials(materials) {
  const container = document.getElementById('materialsList');
  container.innerHTML = '';

  if (!materials.length) {
    container.innerHTML = '<p>No se encontraron materiales.</p>';
    return;
  }

  materials.forEach(mat => {
    const card = document.createElement('div');
    card.className = 'material-card';
    card.innerHTML = `
      <div class="material-info">
        <h3>${mat.descripcion}</h3>
        <div class="material-meta">
          Código: ${mat.codigo} | Unidad: ${mat.unidad} | Precio: $${mat.precio_usd}
        </div>
      </div>
      <div class="material-actions">
        <button class="btn btn-sm btn-secondary" data-codigo="${mat.codigo}">
          Agregar
        </button>
      </div>
    `;
    container.appendChild(card);
  });

  container.querySelectorAll('button[data-codigo]').forEach(btn => {
    btn.addEventListener('click', () => addMaterial(btn.dataset.codigo));
  });
}

function renderSummary() {
  const container = document.getElementById('selectedItems');
  const totalEl = document.getElementById('totalAmount');

  container.innerHTML = '';
  let total = 0;

  (currentSolicitud.items || []).forEach((item, index) => {
    const subtotal = item.cantidad * item.precio_unitario;
    total += subtotal;

    const div = document.createElement('div');
    div.className = 'summary-item';
    div.innerHTML = `
      <div>
        <div>${item.descripcion}</div>
        <small>${item.cantidad} x $${item.precio_unitario}</small>
      </div>
      <div style="text-align: right">
        <div>$${subtotal.toFixed(2)}</div>
        <small class="link-danger" data-index="${index}">Eliminar</small>
      </div>
    `;
    container.appendChild(div);
  });

  container.querySelectorAll('.link-danger').forEach(el => {
    el.addEventListener('click', () => removeItem(parseInt(el.dataset.index, 10)));
  });

  totalEl.textContent = `$${total.toFixed(2)}`;
}

async function addMaterial(codigo) {
  const material = allMaterials.find(m => m.codigo === codigo);
  if (!material) return;

  const qtyStr = prompt(`Cantidad para ${material.descripcion}:`, '1');
  const qty = parseInt(qtyStr, 10);
  if (!qty || isNaN(qty) || qty <= 0) return;

  if (!Array.isArray(currentSolicitud.items)) {
    currentSolicitud.items = [];
  }

  const existing = currentSolicitud.items.find(i => i.codigo === codigo);
  if (existing) {
    existing.cantidad += qty;
  } else {
    currentSolicitud.items.push({
      codigo: material.codigo,
      descripcion: material.descripcion,
      cantidad: qty,
      precio_unitario: material.precio_usd,
      unidad: material.unidad
    });
  }

  await saveSolicitudDraft();
}

async function removeItem(index) {
  if (!confirm('¿Eliminar este ítem?')) return;
  currentSolicitud.items.splice(index, 1);
  await saveSolicitudDraft();
}

async function saveSolicitudDraft() {
  const total = (currentSolicitud.items || []).reduce(
    (sum, i) => sum + i.cantidad * i.precio_unitario,
    0
  );

  const payload = {
    items: (currentSolicitud.items || []).map(item => ({
      codigo: item.codigo,
      descripcion: item.descripcion,
      cantidad: item.cantidad,
      precio_unitario: item.precio_unitario,
      unidad: item.unidad
    })),
    total_monto: total
  };

  try {
    const token = localStorage.getItem('token');
    const res = await fetch(`/api/solicitudes/${solicitudId}/draft`, {
      method: 'PATCH',
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json',
        ...(token ? { 'Authorization': `Bearer ${token}` } : {})
      },
      body: JSON.stringify(payload),
      credentials: 'include'
    });

    if (!res.ok) {
      const err = await res.json().catch(() => ({}));
      throw new Error(err.error?.message || `HTTP ${res.status}`);
    }

    const data = await res.json();
    currentSolicitud = data.solicitud || data;
    renderSummary();
  } catch (err) {
    console.error(err);
    alert('Error guardando borrador: ' + err.message);
  }
}

async function finalizarSolicitud() {
  if (!confirm('¿Finalizar y enviar solicitud para aprobación?')) return;

  if (!currentSolicitud.items || currentSolicitud.items.length === 0) {
    alert('Agrega al menos un material antes de finalizar.');
    return;
  }

  const total = (currentSolicitud.items || []).reduce(
    (sum, i) => sum + i.cantidad * i.precio_unitario,
    0
  );

  const payload = {
    ...currentSolicitud,
    items: currentSolicitud.items,
    total_monto: total,
    status: 'pendiente_de_aprobacion'
  };

  try {
    const token = localStorage.getItem('token');
    const res = await fetch(`/api/solicitudes/${solicitudId}`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json',
        ...(token ? { 'Authorization': `Bearer ${token}` } : {})
      },
      body: JSON.stringify(payload),
      credentials: 'include'
    });

    if (!res.ok) {
      const err = await res.json().catch(() => ({}));
      throw new Error(err.error?.message || `HTTP ${res.status}`);
    }

    alert('Solicitud enviada correctamente');
    window.location.href = '/solicitudes.html';
  } catch (err) {
    console.error(err);
    alert('Error finalizando solicitud: ' + err.message);
  }
}

document.addEventListener('DOMContentLoaded', () => {
  const idSpan = document.getElementById('solicitudId');
  if (idSpan) idSpan.textContent = solicitudId;

  const finalizeBtn = document.getElementById('finalizeBtn');
  if (finalizeBtn) finalizeBtn.addEventListener('click', finalizarSolicitud);

  const searchInput = document.getElementById('searchInput');
  if (searchInput) {
    searchInput.addEventListener('input', (e) => {
      const term = e.target.value.toLowerCase();
      const filtered = allMaterials.filter(m =>
        (m.codigo || '').toLowerCase().includes(term) ||
        (m.descripcion || '').toLowerCase().includes(term)
      );
      renderMaterials(filtered);
    });
  }

  init();
});
  </script>
</body>
</html>
